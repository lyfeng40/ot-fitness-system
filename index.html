<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>職能治療運動追蹤系統 (雲端連線版)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .print-area { background: white; }
        
        @media print {
            .no-print { display: none !important; }
            .print-area { padding: 0 !important; margin: 0 !important; width: 100% !important; }
            body { background-color: white; }
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* PDF 專用頁面容器設定 */
        .pdf-page {
            height: 275mm; /* 固定高度防止溢出 */
            width: 100%;
            overflow: hidden;
            page-break-after: always;
            position: relative;
            background: white;
        }
        .pdf-page:last-child {
            page-break-after: auto;
        }
        
        /* 互動圖表按鈕樣式 */
        .chart-btn {
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
        }
        .chart-btn.active {
            background-color: #86efac;
            border-color: #16a34a;
            font-weight: 500;
        }
        .chart-btn .indicator {
            height: 4px;
            width: 20px;
            display: inline-block;
            margin-left: 6px;
            border-radius: 2px;
        }
        
        /* 下拉選單 */
        .dropdown-content { display: none; position: absolute; background-color: white; min-width: 200px; box-shadow: 0px 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; border-radius: 0.5rem; z-index: 20; max-height: 250px; overflow-y: auto; }
        .dropdown:hover .dropdown-content { display: block; }
    </style>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- 圖表元件 ---
        const ChartComponent = ({ type, data, options }) => {
            const canvasRef = useRef(null);
            const chartInstanceRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || !window.Chart) return;
                if (chartInstanceRef.current) chartInstanceRef.current.destroy();

                try {
                    const ctx = canvasRef.current.getContext('2d');
                    chartInstanceRef.current = new window.Chart(ctx, { type, data, options: options || {} });
                } catch (err) { console.error(err); }
                return () => { if (chartInstanceRef.current) chartInstanceRef.current.destroy(); };
            }, [type, data, options]);

            return <canvas ref={canvasRef} />;
        };

        const Line = (props) => <ChartComponent type="line" {...props} />;
        const Radar = (props) => <ChartComponent type="radar" {...props} />;

        // --- 互動式圖表容器 ---
        const InteractiveChart = ({ title, datasets, labels, initialSelected = [] }) => {
            const [selectedKeys, setSelectedKeys] = useState(initialSelected.length > 0 ? initialSelected : datasets.map(d => d.label));

            const toggleKey = (key) => {
                setSelectedKeys(prev => prev.includes(key) ? prev.filter(k => k !== key) : [...prev, key]);
            };

            const chartData = {
                labels: labels,
                datasets: datasets.filter(d => selectedKeys.includes(d.label))
            };

            return (
                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 h-full flex flex-col">
                    <h3 className="text-lg font-bold text-gray-700 mb-3 text-center">{title}</h3>
                    <div className="flex flex-wrap gap-2 mb-2 justify-center">
                        {datasets.map(d => (
                            <button 
                                key={d.label} 
                                onClick={() => toggleKey(d.label)}
                                className={`chart-btn px-3 py-1 rounded-md text-sm flex items-center ${selectedKeys.includes(d.label) ? 'active' : 'bg-white text-gray-600'}`}
                            >
                                {d.label}
                                <span className="indicator" style={{ backgroundColor: d.borderColor }}></span>
                            </button>
                        ))}
                    </div>
                    <div className="flex-grow min-h-[200px] relative">
                        {selectedKeys.length > 0 ? <Line data={chartData} options={{ maintainAspectRatio: false, plugins: { legend: { display: false } } }} /> 
                        : <div className="flex items-center justify-center h-full text-gray-400 text-sm">請點擊上方按鈕選擇顯示項目</div>}
                    </div>
                </div>
            );
        };

        // --- 邏輯與標準 ---
        const calcAge = (dob) => { if(!dob) return 0; const d = new Date(dob); return new Date().getFullYear() - d.getFullYear(); };
        const calcBMI = (h, w) => (!h || !w) ? 0 : w / Math.pow(h / 100, 2);
        const calcSMI = (h, w, mp) => (!h || !w || !mp) ? 0 : (w * mp / 100) / Math.pow(h / 100, 2);
        const calc6MWTPredicted = (sex, age, h, w) => (sex === "女") ? 2.11*h - 2.29*w - 5.78*age + 667 : 7.57*h - 1.76*w - 5.02*age - 309;
        
        // 評語標準邏輯
        const getBodyFatStatus = (sex, val) => {
            if (sex === "男") {
                if (val < 10) return "低"; if (val < 20) return "標準"; if (val < 25) return "略高"; return "高";
            } else {
                if (val < 20) return "低"; if (val < 30) return "標準"; if (val < 35) return "略高"; return "高";
            }
        };

        const getMuscleStatus = (sex, val) => {
            if (sex === "男") {
                if (val < 32.9) return "低"; if (val < 35.8) return "標準"; if (val < 37.4) return "略高"; return "高";
            } else {
                if (val < 25.9) return "低"; if (val < 28) return "標準"; if (val < 29.1) return "略高"; return "高";
            }
        };

        const getVisceralFatStatus = (val) => {
            if (val <= 9) return "標準"; if (val <= 14) return "略高"; return "高";
        };

        const getSitStandTarget = (sex, age) => {
            if (age >= 3 && age <= 9) return sex === "男" ? 23.1 : 23.4;
            if (age >= 10 && age <= 19) return sex === "男" ? 25.5 : 24.3;
            if (age >= 20 && age <= 59) return sex === "男" ? 24.2 : 22.6;
            if (age >= 60) return sex === "男" ? 18.3 : 15.9;
            return 15;
        };

        const getBMRTarget = (sex, age) => {
            if (sex === '男') {
                if (age >= 15 && age <= 17) return 1570; if (age >= 18 && age <= 29) return 1520;
                if (age >= 30 && age <= 49) return 1520; if (age >= 50 && age <= 69) return 1380; if (age >= 70) return 1230;
            } else {
                if (age >= 15 && age <= 17) return 1270; if (age >= 18 && age <= 29) return 1180;
                if (age >= 30 && age <= 49) return 1140; if (age >= 50 && age <= 69) return 1100; if (age >= 70) return 1030;
            }
            return 1200;
        };

        const getFitnessRating = (type, sex, age, val) => {
            let base = 0;
            if (type === 'sit_ups') {
                if (sex === '男') base = age < 30 ? 35 : age < 40 ? 30 : age < 50 ? 25 : age < 60 ? 20 : 15;
                else base = age < 30 ? 27 : age < 40 ? 22 : age < 50 ? 17 : age < 60 ? 13 : 8;
            } else {
                if (sex === '男') base = age < 30 ? 28 : age < 40 ? 24 : age < 50 ? 18 : age < 60 ? 15 : 12;
                else base = age < 30 ? 33 : age < 40 ? 30 : age < 50 ? 27 : age < 60 ? 25 : 22;
            }
            if (val < base * 0.6) return { s: "不好", c: "text-red-600" };
            if (val < base * 0.8) return { s: "稍差", c: "text-orange-600" };
            if (val < base * 1.2) return { s: "適當", c: "text-blue-600" };
            if (val < base * 1.4) return { s: "良好", c: "text-green-600" };
            return { s: "很好", c: "text-green-700 font-bold" };
        };

        const getStandard = (type, val, sex, age) => {
            if (type === 'sit_stand') {
                const target = getSitStandTarget(sex, age);
                if (val < target) return { status: `低於標準(${target})`, color: 'text-red-600' };
                return { status: "標準", color: 'text-green-600' };
            }
            if (type === 'walk') return { status: "-", color: "" };
            if (type === 'sit_ups') {
                const r = getFitnessRating('sit_ups', sex, age, val);
                return { status: r.s, color: r.c };
            }
            if (type === 'flexibility') {
                const r = getFitnessRating('flexibility', sex, age, val);
                return { status: r.s, color: r.c };
            }
            return { status: "-", color: "" };
        };

        const getBMIStatus = (bmi) => bmi < 18.5 ? "體重太輕" : bmi < 24 ? "標準體重" : bmi < 27 ? "過重" : bmi < 30 ? "輕度肥胖" : bmi < 35 ? "中度肥胖" : "重度肥胖";
        const getSarcopeniaStatus = (sex, smi) => (sex === "男" && smi < 7.0) || (sex === "女" && smi < 5.7) ? "肌少症" : "正常";
        const getWHRStatus = (sex, v) => (sex === "男" && v < 0.92) || (sex === "女" && v < 0.88) ? "標準" : "過高";
        
        const normalizeScore = (val, target, type = 'higher_better') => {
            if (!val || !target) return 0;
            let score = type === 'higher_better' ? (val / target) * 100 : val <= target ? 100 : (target / val) * 100;
            return Math.min(Math.max(score, 10), 120);
        };

        // --- 主程式 ---
        const Dashboard = () => {
            // ★★★ 關鍵修改處：已填入你的 GAS 網址 ★★★
            const API_URL = "https://script.google.com/macros/s/AKfycbzekI8XHd-ZaT32mCqHzaatmOhB5LSZzNZyfHFIEqkkCUGESm1SCBPO3Hu63mgRUjxEWA/exec";
        
            // 使用 State 存密碼與登入狀態
            const [apiPass, setApiPass] = useState(""); 
            const [isLoggedIn, setIsLoggedIn] = useState(false);

            const [data, setData] = useState([]);
            const [currentPage, setCurrentPage] = useState('population');
            const [isLoading, setIsLoading] = useState(false);
            
            const processData = (rawData) => {
                return rawData.map(row => {
                    const bmi = calcBMI(row.height, row.weight);
                    const smi = calcSMI(row.height, row.weight, row.muscle_percent);
                    const whr = (row.waist && row.hip) ? row.waist / row.hip : 0;
                    const predicted6m = calc6MWTPredicted(row.sex, row.age, row.height, row.weight);
                    const bmrTarget = getBMRTarget(row.sex, row.age);
                    const bmrStatus = (row.bmr < bmrTarget * 0.9) ? "偏低" : (row.bmr > bmrTarget * 1.1) ? "偏高" : "標準";

                    return {
                        ...row,
                        bmi: parseFloat(bmi.toFixed(1)),
                        smi: parseFloat(smi.toFixed(1)),
                        whr: parseFloat(whr.toFixed(1)),
                        predicted_walk_6m: parseFloat(predicted6m.toFixed(0)),
                        bmi_status: getBMIStatus(bmi),
                        sarcopenia_status: getSarcopeniaStatus(row.sex, smi),
                        visceral_status: getVisceralFatStatus(row.visceral_fat),
                        body_fat_status: getBodyFatStatus(row.sex, row.body_fat),
                        muscle_status: getMuscleStatus(row.sex, row.muscle_percent),
                        whr_status: getWHRStatus(row.sex, whr),
                        bmr_status: bmrStatus
                    };
                });
            };

            // 從 Google Sheets 抓取資料 (GET)
            const fetchData = async () => {
                setIsLoading(true);
                try {
                   // 使用使用者輸入的 apiPass
                    const res = await fetch(`${API_URL}?password=${apiPass}`);
                    const json = await res.json();
                    
                    if (json.status === 'success') {
                        // 將 GAS 回傳的資料對應回前端欄位
                        const sheetData = json.data.map(row => ({
                            id: row['唯一識別碼'],
                            bed_number: row['床號'],
                            name: row['姓名'],
                            sex: row['性別'],
                            dob: row['出生年月日'] ? new Date(row['出生年月日']).toISOString().split('T')[0] : "",
                            age: Number(row['年齡']),
                            session: row['評估次別'],
                            date: row['評估日期'] ? new Date(row['評估日期']).toISOString().split('T')[0] : "",
                            height: Number(row['身高(cm)']),
                            weight: Number(row['體重(kg)']),
                            bmi: Number(row['BMI']),
                            body_fat: Number(row['體脂肪(%)']),
                            muscle_percent: Number(row['骨骼肌(%)']),
                            visceral_fat: Number(row['內臟脂肪']),
                            smi: Number(row['SMI']),
                            bmr: Number(row['基礎代謝(kcal)']),
                            body_age: Number(row['體年齡']),
                            waist: Number(row['腰圍(cm)']),
                            hip: Number(row['臀圍(cm)']),
                            whr: Number(row['腰臀比']),
                            sit_ups_1m: Number(row['一分鐘仰臥起坐(次)']),
                            walk_6m: Number(row['六分鐘行走測驗(m)']),
                            flexibility: Number(row['柔軟度(cm)']),
                            sit_stand_30s: Number(row['30秒坐站測驗(次)'])
                        }));
                        setData(processData(sheetData));
                    } else {
                        console.error("API Error: " + json.message);
                        alert("讀取資料失敗：" + json.message);
                    }
                } catch (err) {
                    console.error("Fetch Error:", err);
                    alert("無法連線到資料庫，請檢查網路連線。");
                } finally {
                    setIsLoading(false);
                }
            };


            // --- Page 1: 族群概況 ---
            const PopulationView = () => {
                const allDates = [...new Set(data.map(d => d.date))].sort();
                const [selectedDates, setSelectedDates] = useState(allDates);
                const toggleDate = (d) => setSelectedDates(prev => prev.includes(d) ? prev.filter(x=>x!==d) : [...prev,d]);
                const filteredData = data.filter(d => selectedDates.length === 0 || selectedDates.includes(d.date));
                
                const latestMap = new Map();
                filteredData.forEach(d => {
                    const key = `${d.name}_${d.dob}`;
                    if (!latestMap.has(key) || new Date(d.date) > new Date(latestMap.get(key).date)) {
                        latestMap.set(key, d);
                    }
                });
                const latestRecords = Array.from(latestMap.values());
                const totalPeople = latestRecords.length;
                const males = latestRecords.filter(d => d.sex === '男').length;
                const avgAge = totalPeople ? (latestRecords.reduce((a,b) => a + b.age, 0) / totalPeople).toFixed(1) : 0;
                
                const riskSarcopenia = latestRecords.filter(d => d.sarcopenia_status === '肌少症').length;
                const riskVisceral = latestRecords.filter(d => d.visceral_status !== '標準').length;
                const riskObesity = latestRecords.filter(d => ['中度肥胖', '重度肥胖', '過重'].includes(d.bmi_status)).length;
                const riskFlexibility = latestRecords.filter(d => d.flexibility < 20).length;

                const datesForChart = selectedDates.length > 0 ? selectedDates.sort() : allDates;
                const getAvg = (date, field) => {
                    const dayData = data.filter(d => d.date === date);
                    return dayData.length ? parseFloat((dayData.reduce((a,b)=>a+(b[field]||0),0)/dayData.length).toFixed(1)) : 0;
                };

                const bodyDatasets = [
                    { label: '體重', data: datesForChart.map(d=>getAvg(d,'weight')), borderColor: '#ef4444' }, 
                    { label: 'BMI', data: datesForChart.map(d=>getAvg(d,'bmi')), borderColor: '#8b5cf6' },
                    { label: '骨骼肌', data: datesForChart.map(d=>getAvg(d,'muscle_percent')), borderColor: '#10b981' },
                    { label: '體脂率', data: datesForChart.map(d=>getAvg(d,'body_fat')), borderColor: '#f59e0b' },
                    { label: '內臟脂肪', data: datesForChart.map(d=>getAvg(d,'visceral_fat')), borderColor: '#2563eb' }
                ];
                
                const fitnessDatasets = [
                    { label: '6分鐘行走', data: datesForChart.map(d=>getAvg(d,'walk_6m')), borderColor: '#8b5cf6' },
                    { label: '30秒坐站', data: datesForChart.map(d=>getAvg(d,'sit_stand_30s')), borderColor: '#ec4899' },
                    { label: '仰臥起坐', data: datesForChart.map(d=>getAvg(d,'sit_ups_1m')), borderColor: '#f59e0b' },
                    { label: '柔軟度', data: datesForChart.map(d=>getAvg(d,'flexibility')), borderColor: '#06b6d4' }
                ];

                return (
                    <div className="space-y-6 animate-fade-in pb-12">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h2 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">全體學員健康風險儀表板</h2>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                <div className="text-center p-3 bg-gray-50 rounded"><p className="text-gray-500 text-sm">總評估人數</p><p className="text-2xl font-bold">{totalPeople} 人</p></div>
                                <div className="text-center p-3 bg-gray-50 rounded"><p className="text-gray-500 text-sm">男女比例</p><p className="text-2xl font-bold text-blue-600">{males} : <span className="text-pink-500">{totalPeople-males}</span></p></div>
                                <div className="text-center p-3 bg-gray-50 rounded"><p className="text-gray-500 text-sm">平均年齡</p><p className="text-2xl font-bold">{avgAge} 歲</p></div>
                                
                                <div className="text-center p-3 bg-gray-50 rounded relative dropdown group cursor-pointer">
                                    <p className="text-gray-500 text-sm mb-1">評估日期篩選 (可複選) ▾</p>
                                    <div className="font-bold text-lg text-blue-600">{selectedDates.length} 個</div>
                                    <div className="dropdown-content left-0 right-0 mx-auto">
                                        {allDates.map(d => (
                                            <label key={d} className="flex items-center space-x-2 p-2 hover:bg-gray-100 cursor-pointer text-left text-sm border-b">
                                                <input type="checkbox" checked={selectedDates.includes(d)} onChange={() => toggleDate(d)} className="form-checkbox h-4 w-4 text-blue-600" />
                                                <span>{d}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                {[
                                    { t: "肌少症風險", c: riskSarcopenia, color: "orange" }, { t: "內臟脂肪過高", c: riskVisceral, color: "red" },
                                    { t: "BMI肥胖/過重", c: riskObesity, color: "blue" }, { t: "柔軟度不佳", c: riskFlexibility, color: "purple" }
                                ].map((r, i) => (
                                    <div key={i} className={`p-4 rounded-lg border-l-4 shadow-sm bg-white border-${r.color}-500`}>
                                        <h3 className="text-gray-500 text-sm">{r.t}</h3>
                                        <div className="flex items-end gap-2 mt-1"><span className="text-2xl font-bold">{r.c}</span><span className="text-sm text-gray-400">/ {totalPeople} ({totalPeople?Math.round(r.c/totalPeople*100):0}%)</span></div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <InteractiveChart title="身體素質平均分析" datasets={bodyDatasets} labels={datesForChart} />
                            <InteractiveChart title="體能表現平均分析" datasets={fitnessDatasets} labels={datesForChart} />
                        </div>
                    </div>
                );
            };

            // --- Page 2: 個案報告 ---
            const IndividualReportView = () => {
                const uniquePeople = useMemo(() => {
                    const map = new Map();
                    data.forEach(d => {
                        const key = `${d.name}_${d.dob}`;
                        if (!map.has(key)) map.set(key, d);
                    });
                    return Array.from(map.values()).sort((a,b) => a.name.localeCompare(b.name));
                }, [data]);

                const [selKey, setSelKey] = useState("");
                const [selDate, setSelDate] = useState("");

                useEffect(() => {
                    if (uniquePeople.length > 0 && !selKey) {
                        setSelKey(`${uniquePeople[0].name}_${uniquePeople[0].dob}`);
                    }
                }, [uniquePeople]);

                const personRecords = useMemo(() => {
                    if (!selKey) return [];
                    const [n, d] = selKey.split('_');
                    return data.filter(r => r.name === n && r.dob === d).sort((a,b) => new Date(a.date) - new Date(b.date));
                }, [selKey, data]);

                const availableDates = personRecords.map(r => r.date);
                useEffect(() => { if(availableDates.length > 0 && !availableDates.includes(selDate)) setSelDate(availableDates[availableDates.length-1]); }, [selKey, personRecords]);

                const current = personRecords.find(r => r.date === selDate) || {};

                const radarScores = current.id ? [
                    normalizeScore(current.bmi, 22, 'lower_better'), normalizeScore(current.smi, 7.0, 'higher_better'),
                    normalizeScore(current.walk_6m, current.predicted_walk_6m, 'higher_better'), normalizeScore(current.sit_stand_30s, 15, 'higher_better'),
                    normalizeScore(current.flexibility, 30, 'higher_better'), normalizeScore(current.sit_ups_1m, 25, 'higher_better'),
                ] : [0,0,0,0,0,0];
                
                const fitnessScore = (radarScores[2] + radarScores[3] + radarScores[4] + radarScores[5]) / 4;
                const bodyScore = (radarScores[0] + radarScores[1]) / 2;
                const compositeScore = Math.round(fitnessScore * 0.6 + bodyScore * 0.4);
                
                const radarData = { labels: ['BMI', 'SMI', '心肺', '下肢', '柔軟度', '核心'], datasets: [{ label: '分數', data: radarScores, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 2 }] };

                const sitStandStd = current.id ? getStandard('sit_stand', current.sit_stand_30s, current.sex, current.age) : {};
                const flexStd = current.id ? getStandard('flexibility', current.flexibility, current.sex, current.age) : {};
                const sitUpsStd = current.id ? getStandard('sit_ups', current.sit_ups_1m, current.sex, current.age) : {};
                const walkStd = current.id ? (current.walk_6m < current.predicted_walk_6m ? {s: `低於預測(${current.predicted_walk_6m})`, c: 'text-red-600'} : {s: "佳", c: 'text-green-600'}) : {};

                const generateAnalysis = () => {
                    const statusText = compositeScore >= 80 ? '優良' : compositeScore >= 60 ? '尚可' : '待加強';
                    const bmiAnalysis = current.bmi > 24 ? "過重" : current.bmi < 18.5 ? "過輕" : "標準";
                    const muscleText = current.smi < 7 ? "肌肉量明顯不足，伴隨肌少症風險" : "肌肉量維持在良好水平";
                    
                    return `【綜合功能分析】
經由本次專業職能治療體適能評估，${current.name}學員的整體體適能評分為 ${compositeScore} 分，整體表現屬於${statusText}。
在身體組成方面，您的BMI指數顯示體重${bmiAnalysis}，這直接影響身體的代謝負擔；而骨骼肌指數(SMI)顯示${muscleText}，這對於維持基礎代謝率及日常活動的抗疲勞能力至關重要。

在功能性體能方面，六分鐘行走測試反映了您的心肺耐力，目前的表現${current.walk_6m < current.predicted_walk_6m ? "低於預測值，顯示有氧能力稍弱，容易在長距離移動或爬坡時感到氣喘與疲累" : "優於預測值，顯示具備良好的心肺循環效率，能應付較高強度的活動"}。30秒坐站測試則反映下肢肌力，${sitStandStd.status.includes('低於') ? "目前次數偏低，顯示下肢爆發力不足，未來可能增加跌倒風險或影響如廁起身" : "目前表現穩定，顯示下肢功能足以應付日常生活轉位需求"}。此外，柔軟度測試結果顯示${flexStd.status.includes('差') || flexStd.status.includes('不好') ? "關節活動度受限，長期可能導致姿勢不良或肌肉痠痛" : "關節活動範圍良好，有助於動作的流暢性"}。

【治療師建議】
針對上述評估結果，建議您設定短期目標為提升${current.smi < 7 ? "下肢肌力" : "心肺耐力"}，長期目標則為建立規律的運動習慣以預防退化。職能治療師建議您參考下方的個別化運動處方，並在日常生活中增加${current.walk_6m < current.predicted_walk_6m ? "步行機會" : "伸展頻率"}。透過持續的介入與追蹤，我們預期能有效提升您的生活品質與健康壽命。`;
                };
                const otAnalysis = current.id ? generateAnalysis() : "";

                const downloadPDF = () => {
                    const el = document.getElementById('report-container');
                    const opt = {
                        margin: 5,
                        filename: `${current.name}_${selDate}_完整報告.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 4, useCORS: true }, 
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };
                    html2pdf().from(el).set(opt).save();
                };

                const dates = personRecords.map(r=>r.date);
                const chartGroup1 = [
                    { label: '體重', data: personRecords.map(r=>r.weight), borderColor: '#ef4444' },
                    { label: '體脂率', data: personRecords.map(r=>r.body_fat), borderColor: '#f59e0b' },
                    { label: '骨骼肌', data: personRecords.map(r=>r.muscle_percent), borderColor: '#10b981' }
                ];
                const chartGroup2 = [
                    { label: '內臟脂肪', data: personRecords.map(r=>r.visceral_fat), borderColor: '#2563eb' },
                    { label: '柔軟度', data: personRecords.map(r=>r.flexibility), borderColor: '#06b6d4' }
                ];
                const chartGroup3 = [
                    { label: '30秒坐站', data: personRecords.map(r=>r.sit_stand_30s), borderColor: '#ec4899' },
                    { label: '仰臥起坐', data: personRecords.map(r=>r.sit_ups_1m), borderColor: '#f59e0b' }
                ];
                const chartGroup4 = [
                    { label: '6分鐘行走', data: personRecords.map(r=>r.walk_6m), borderColor: '#8b5cf6' }
                ];

                if(!current.id) return <div className="p-10 text-center">請先匯入資料</div>;

                return (
                    <div className="pb-10">
                        <div className="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-wrap gap-4 items-center justify-between no-print">
                            <div className="flex gap-4 items-center">
                                <label className="font-bold">學員: 
                                    <select className="border rounded p-1" value={selKey} onChange={e => setSelKey(e.target.value)}>
                                        {uniquePeople.map(p => (
                                            <option key={`${p.name}_${p.dob}`} value={`${p.name}_${p.dob}`}>{p.name} ({p.dob})</option>
                                        ))}
                                    </select>
                                </label>
                                <label className="font-bold">日期: 
                                    <select className="border rounded p-1" value={selDate} onChange={e => setSelDate(e.target.value)}>
                                        {availableDates.map(d=><option key={d} value={d}>{d}</option>)}
                                    </select>
                                </label>
                            </div>
                            <button onClick={downloadPDF} className="bg-blue-600 text-white px-4 py-2 rounded shadow"><i className="fas fa-print mr-2"></i>下載/列印</button>
                        </div>

                        <div id="report-container" className="max-w-[210mm] mx-auto bg-white shadow-lg">
                            {/* Page 1 */}
                            <div className="pdf-page p-8 flex flex-col items-stretch">
                                <div className="border-b-4 border-blue-600 pb-2 mb-2 text-center">
                                    <h1 className="text-3xl font-bold text-gray-800">體適能評估與介入建議書</h1>
                                </div>
                                <div className="bg-blue-50 p-2 rounded mb-2 grid grid-cols-5 gap-2 text-center text-sm border border-blue-100">
                                    <div><p className="text-gray-500 text-xs">評估日期</p><b>{current.date}</b></div>
                                    <div><p className="text-gray-500 text-xs">床號</p><b>{current.bed_number||"未填"}</b></div>
                                    <div><p className="text-gray-500 text-xs">姓名</p><b className="text-lg">{current.name}</b></div>
                                    <div><p className="text-gray-500 text-xs">性別/年齡</p><b>{current.sex} / {current.age}歲</b></div>
                                    <div><p className="text-gray-500 text-xs">出生年月日</p><b>{current.dob||"未填"}</b></div>
                                </div>

                                <div className="grid grid-cols-2 gap-4 mb-2 flex-grow items-stretch">
                                    {/* 左欄：身體素質 + 綜合分數/雷達圖 */}
                                    <div className="flex flex-col h-full bg-white border rounded p-2 border-gray-200">
                                        <h3 className="bg-gray-800 text-white text-center text-sm py-1 font-bold rounded-t mb-2">身體素質表現</h3>
                                        <table className="w-full text-xs border border-gray-300 text-center mb-2">
                                            <thead className="bg-gray-100"><tr><th className="border p-1 whitespace-nowrap">項目</th><th className="border p-1 whitespace-nowrap">數值</th><th className="border p-1 whitespace-nowrap">標準/評語</th></tr></thead>
                                            <tbody>
                                                <tr><td className="border p-1 whitespace-nowrap">身高/體重</td><td className="border p-1 whitespace-nowrap">{current.height.toFixed(1)} / {current.weight.toFixed(1)}</td><td className="border p-1 whitespace-nowrap">-</td></tr>
                                                <tr><td className="border p-1 whitespace-nowrap">BMI</td><td className="border p-1 whitespace-nowrap">{current.bmi.toFixed(1)}</td><td className="border p-1 whitespace-nowrap font-bold text-blue-600">{current.bmi_status}</td></tr>
                                                <tr><td className="border p-1 whitespace-nowrap">體脂率</td><td className="border p-1 whitespace-nowrap">{current.body_fat.toFixed(1)}%</td><td className="border p-1 whitespace-nowrap">{current.body_fat_status}</td></tr>
                                                <tr><td className="border p-1 whitespace-nowrap">骨骼肌(%)</td><td className="border p-1 whitespace-nowrap">{current.muscle_percent.toFixed(1)}%</td><td className="border p-1 whitespace-nowrap">{current.muscle_status}</td></tr>
                                                <tr><td className="border p-1 whitespace-nowrap">SMI(指數)</td><td className="border p-1 whitespace-nowrap">{current.smi.toFixed(1)}</td><td className="border p-1 whitespace-nowrap font-bold text-blue-600">{current.sarcopenia_status}</td></tr>
                                                <tr><td className="border p-1 whitespace-nowrap">內臟脂肪</td><td className="border p-1 whitespace-nowrap">{current.visceral_fat.toFixed(1)}</td><td className="border p-1 whitespace-nowrap text-red-500">{current.visceral_status}</td></tr>
                                                <tr><td className="border p-1 whitespace-nowrap">體年齡</td><td className="border p-1 whitespace-nowrap">{current.body_age||"-"}</td><td className="border p-1 whitespace-nowrap">{current.body_age ? (current.body_age > current.age ? `+${current.body_age-current.age} (老化)` : `-${current.age-current.body_age} (年輕)`) : "-"}</td></tr>
                                                <tr><td className="border p-1 whitespace-nowrap">基礎代謝</td><td className="border p-1 whitespace-nowrap">{current.bmr ? Number(current.bmr).toFixed(1) : "-"}</td><td className="border p-1 whitespace-nowrap">{current.bmr_status}</td></tr>
                                                <tr><td className="border p-1 whitespace-nowrap">腰圍/臀圍</td><td className="border p-1 whitespace-nowrap">{current.waist ? Number(current.waist).toFixed(1) : "-"}/{current.hip ? Number(current.hip).toFixed(1) : "-"}</td><td className="border p-1 whitespace-nowrap">cm</td></tr>
                                                <tr><td className="border p-1 whitespace-nowrap">腰臀比</td><td className="border p-1 whitespace-nowrap">{current.whr.toFixed(1)}</td><td className="border p-1 whitespace-nowrap">{current.whr_status} (標準: {current.sex==='男'?'<0.92':'<0.88'})</td></tr>
                                            </tbody>
                                        </table>
                                        
                                        <div className="mt-1 flex-grow flex flex-col items-center justify-center border rounded p-2 relative h-full">
                                            <div className="w-full flex-grow relative min-h-[150px]"><Radar data={radarData} options={{ maintainAspectRatio: false, scales: { r: { min: 0, max: 120, ticks: { display: false } } }, plugins: { legend: { display: false } } }} /></div>
                                            <div className="absolute bottom-1 bg-white/80 px-2 rounded">
                                                <div className="text-xs text-gray-500 text-center">綜合體適能分數</div>
                                                <div className="text-4xl font-bold text-blue-600 text-center">{compositeScore}</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* 右欄：體能表現 + OT評語 */}
                                    <div className="flex flex-col h-full bg-white border rounded p-2 border-gray-200">
                                        <h3 className="bg-gray-800 text-white text-center text-sm py-1 font-bold rounded-t mb-2">體能表現評估</h3>
                                        <table className="w-full text-xs border border-gray-300 text-center mb-2">
                                            <thead className="bg-gray-100"><tr><th className="border p-1 whitespace-nowrap">項目</th><th className="border p-1 whitespace-nowrap">數值</th><th className="border p-1 whitespace-nowrap">評語</th></tr></thead>
                                            <tbody>
                                                <tr><td className="border p-1 whitespace-nowrap">30秒坐站</td><td className="border p-1 whitespace-nowrap font-bold">{Number(current.sit_stand_30s).toFixed(1)} 次</td><td className={`border p-1 whitespace-nowrap ${sitStandStd.color}`}>{sitStandStd.status}</td></tr>
                                                <tr><td className="border p-1 whitespace-nowrap">6分鐘行走</td><td className="border p-1 whitespace-nowrap font-bold">{Number(current.walk_6m).toFixed(1)} m</td><td className={`border p-1 whitespace-nowrap ${walkStd.c}`}>{walkStd.s}</td></tr>
                                                <tr><td className="border p-1 whitespace-nowrap">柔軟度</td><td className="border p-1 whitespace-nowrap font-bold">{Number(current.flexibility).toFixed(1)} cm</td><td className={`border p-1 whitespace-nowrap ${flexStd.color}`}>{flexStd.status}</td></tr>
                                                <tr><td className="border p-1 whitespace-nowrap">仰臥起坐</td><td className="border p-1 whitespace-nowrap font-bold">{Number(current.sit_ups_1m).toFixed(1)} 次</td><td className={`border p-1 whitespace-nowrap ${sitUpsStd.color}`}>{sitUpsStd.status}</td></tr>
                                            </tbody>
                                        </table>
                                        
                                        <div className="mt-auto bg-orange-50 p-2 rounded flex-grow flex flex-col text-xs leading-relaxed border border-orange-100">
                                            <h4 className="font-bold text-orange-800 mb-1 border-b border-orange-200 pb-1 text-base"><i className="fas fa-user-md mr-1"></i>OT 綜合評語與建議</h4>
                                            
                                            <div className="mb-2 text-justify whitespace-pre-line leading-snug flex-grow text-[11px]">
                                                {otAnalysis}
                                            </div>

                                            <div className="grid grid-cols-1 gap-1.5 mt-1">
                                                <div className="bg-white p-1.5 rounded border border-green-200">
                                                    <strong className="text-green-700 flex items-center mb-1 text-sm justify-between">
                                                        <span><i className="fas fa-dumbbell mr-1"></i>運動處方</span>
                                                        <span className="text-[10px] bg-green-100 px-1 rounded">頻率: 每週3次</span>
                                                    </strong>
                                                    <ul className="list-disc pl-4 space-y-0.5 text-gray-700 text-[11px]">
                                                        {current.sarcopenia_status === '肌少症' && <li><strong>阻力：</strong>彈力帶胸推、深蹲 (3組x10次)，增加肌肉量。</li>}
                                                        {current.walk_6m < current.predicted_walk_6m && <li><strong>有氧：</strong>快走/單車 (20分/次)，強度自覺稍微喘。</li>}
                                                        {current.flexibility < 20 && <li><strong>伸展：</strong>貓牛式、腿後伸展，停留15秒，勿憋氣。</li>}
                                                        {!['肌少症'].includes(current.sarcopenia_status) && current.walk_6m >= current.predicted_walk_6m && <li><strong>維持：</strong>保持現有活動，可嘗試間歇運動增加強度。</li>}
                                                        <li className="text-gray-500 mt-0.5 pt-0.5 border-t border-dashed"><strong>注意：</strong>運動時若感頭暈心悸請立即停止並休息。</li>
                                                    </ul>
                                                </div>
                                                <div className="bg-white p-1.5 rounded border border-red-200">
                                                    <strong className="text-red-700 flex items-center mb-1 text-sm"><i className="fas fa-utensils mr-1"></i>營養建議</strong>
                                                    <ul className="list-disc pl-4 space-y-0.5 text-gray-700 text-[11px]">
                                                        {current.bmi > 24 && <li><strong>控糖：</strong>減少含糖飲料，精緻澱粉減半，多吃高纖蔬菜。</li>}
                                                        {(current.smi < 7) ? <li><strong>增肌：</strong>運動後30分內補充蛋白質(豆漿/茶葉蛋)。</li> : <li><strong>均衡：</strong>每餐蔬菜大於拳頭大，每日飲水2000cc。</li>}
                                                        <li><strong>骨骼：</strong>每日早晚一杯奶或補充小魚乾、黑芝麻。</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Page 2 */}
                            <div className="pdf-page p-8 relative">
                                <div className="border-b-4 border-gray-600 pb-4 mb-6 text-center">
                                    <h1 className="text-3xl font-bold text-gray-800">歷程追蹤分析報告</h1>
                                    <p className="text-gray-500 mt-2">學員: {current.name} ( {personRecords[0].date} ~ {personRecords[personRecords.length-1].date} )</p>
                                </div>
                                <div className="grid grid-cols-2 gap-6 h-[800px]">
                                    <InteractiveChart title="身體組成 (體重/體脂/骨骼肌)" datasets={chartGroup1} labels={dates} initialSelected={['體重', '骨骼肌']} />
                                    <InteractiveChart title="身體指標 (內臟脂肪/柔軟度)" datasets={chartGroup2} labels={dates} initialSelected={['內臟脂肪']} />
                                    <InteractiveChart title="肌力表現 (坐站/仰臥)" datasets={chartGroup3} labels={dates} />
                                    <InteractiveChart title="心肺耐力 (6分鐘行走)" datasets={chartGroup4} labels={dates} />
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // --- Page 3: 資料輸入 ---
            const DataEntryView = () => {
                const [form, setForm] = useState({ 
                    date: new Date().toISOString().split('T')[0], bed_number: '', name: '', 
                    dob: '', age: '', sex: '男',
                    height: '', weight: '', waist: '', hip: '', 
                    body_fat: '', muscle_percent: '', visceral_fat: '', body_age: '', bmr: '',
                    sit_stand_30s: '', walk_6m: '', flexibility: '', sit_ups_1m: '' 
                });
                const [isSubmitting, setIsSubmitting] = useState(false);

                const handleChange = (e) => {
                    const { name, value } = e.target;
                    let newForm = { ...form, [name]: value };
                    if (name === 'dob') newForm.age = calcAge(value);
                    setForm(newForm);
                };

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    setIsSubmitting(true);

                    const height = parseFloat(form.height);
                    const weight = parseFloat(form.weight);
                    const muscle_percent = parseFloat(form.muscle_percent);
                    const bmi = calcBMI(height, weight);
                    const smi = calcSMI(height, weight, muscle_percent);
                    const muscle_kg = (weight * muscle_percent / 100).toFixed(1);
                    const whr = (form.waist && form.hip) ? (form.waist / form.hip).toFixed(2) : 0;

                    const payload = {
                        password: apiPass,
                        id: Date.now().toString(),
                        bed_number: form.bed_number,
                        name: form.name,
                        sex: form.sex,
                        dob: form.dob,
                        age: form.age,
                        session: 1, 
                        date: form.date,
                        height: height,
                        weight: weight,
                        bmi: bmi.toFixed(1),
                        body_fat: form.body_fat,
                        muscle_percent: muscle_percent,
                        muscle_kg: muscle_kg,
                        smi: smi.toFixed(1),
                        bmr: form.bmr,
                        body_age: form.body_age,
                        visceral_fat: form.visceral_fat,
                        waist: form.waist,
                        hip: form.hip,
                        whr: whr,
                        sit_ups_1m: form.sit_ups_1m,
                        walk_6m: form.walk_6m,
                        flexibility: form.flexibility,
                        sit_stand_30s: form.sit_stand_30s
                    };

                    try {
                        const res = await fetch(API_URL, {
                            method: "POST",
                            headers: { "Content-Type": "text/plain;charset=utf-8" },
                            body: JSON.stringify(payload)
                        });
                        const json = await res.json();
                        
                        if (json.status === 'success') {
                            alert("✅ 資料已成功儲存到 Google Sheets！");
                            fetchData();
                            setForm({ ...form, name: '', bed_number: '' });
                        } else {
                            alert("❌ 儲存失敗：" + json.message);
                        }
                    } catch (err) {
                        console.error(err);
                        alert("儲存時發生錯誤 (請確認網路或 API 網址是否正確)");
                    } finally {
                        setIsSubmitting(false);
                    }
                };

                return (
                    <div className="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-sm">
                        <div className="flex justify-between items-center mb-6 border-b pb-4">
                            <h2 className="text-2xl font-bold text-gray-800">資料輸入 (上傳至雲端)</h2>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div className="space-y-4">
                                <h3 className="font-bold text-blue-800 border-l-4 border-blue-600 pl-2">1. 基本資料</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <label className="block text-sm">評估日期 <input required type="date" name="date" value={form.date} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                    <label className="block text-sm">床號 <input type="text" name="bed_number" value={form.bed_number} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                    <label className="block text-sm">姓名 <input required type="text" name="name" value={form.name} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                    <label className="block text-sm">性別 <select name="sex" value={form.sex} onChange={handleChange} className="w-full border p-2 rounded"><option>男</option><option>女</option></select></label>
                                    <label className="block text-sm">出生年月日 <input required type="date" name="dob" value={form.dob} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                    <label className="block text-sm">年齡 (自動) <input type="number" readOnly name="age" value={form.age} className="w-full border p-2 rounded bg-gray-100" /></label>
                                </div>
                            </div>
                            <div className="space-y-4">
                                <h3 className="font-bold text-blue-800 border-l-4 border-blue-600 pl-2">2. 身體素質</h3>
                                <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                                    <label className="block text-sm">身高 (cm) <input required type="number" name="height" value={form.height} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                    <label className="block text-sm">體重 (kg) <input required type="number" name="weight" value={form.weight} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                    <label className="block text-sm">腰圍 (cm) <input type="number" name="waist" value={form.waist} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                    <label className="block text-sm">臀圍 (cm) <input type="number" name="hip" value={form.hip} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                    <label className="block text-sm">體脂率 (%) <input type="number" name="body_fat" value={form.body_fat} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                    <label className="block text-sm">骨骼肌 (%) <input type="number" name="muscle_percent" value={form.muscle_percent} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                    <label className="block text-sm">內臟脂肪 <input type="number" name="visceral_fat" value={form.visceral_fat} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                    <label className="block text-sm">體年齡 <input type="number" name="body_age" value={form.body_age} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                    <label className="block text-sm">基礎代謝 <input type="number" name="bmr" value={form.bmr} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                </div>
                            </div>
                            <div className="space-y-4">
                                <h3 className="font-bold text-blue-800 border-l-4 border-blue-600 pl-2">3. 體能表現</h3>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <label className="block text-sm">30秒坐站 (次) <input type="number" name="sit_stand_30s" value={form.sit_stand_30s} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                    <label className="block text-sm">6分鐘行走 (m) <input type="number" name="walk_6m" value={form.walk_6m} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                    <label className="block text-sm">柔軟度 (cm) <input type="number" name="flexibility" value={form.flexibility} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                    <label className="block text-sm">仰臥起坐 (次) <input type="number" name="sit_ups_1m" value={form.sit_ups_1m} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                </div>
                            </div>
                            <button type="submit" disabled={isSubmitting} className={`w-full py-3 rounded-lg font-bold shadow text-white ${isSubmitting ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}>
                                {isSubmitting ? "資料上傳中..." : "新增並上傳資料"}
                            </button>
                        </form>
                    </div>
                );
            };
// --- 新增：登入處理函數 ---
            const handleLogin = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                try {
                    // 嘗試用輸入的密碼連線
                    const res = await fetch(`${API_URL}?password=${apiPass}`);
                    const json = await res.json();
                    
                    if (json.status === 'success') {
                        // 驗證成功，手動執行原本的資料處理邏輯
                        const sheetData = json.data.map(row => ({
                            id: row['唯一識別碼'], bed_number: row['床號'], name: row['姓名'], sex: row['性別'],
                            dob: row['出生年月日'] ? new Date(row['出生年月日']).toISOString().split('T')[0] : "",
                            age: Number(row['年齡']), session: row['評估次別'],
                            date: row['評估日期'] ? new Date(row['評估日期']).toISOString().split('T')[0] : "",
                            height: Number(row['身高(cm)']), weight: Number(row['體重(kg)']), bmi: Number(row['BMI']),
                            body_fat: Number(row['體脂肪(%)']), muscle_percent: Number(row['骨骼肌(%)']), visceral_fat: Number(row['內臟脂肪']),
                            smi: Number(row['SMI']), bmr: Number(row['基礎代謝(kcal)']), body_age: Number(row['體年齡']),
                            waist: Number(row['腰圍(cm)']), hip: Number(row['臀圍(cm)']), whr: Number(row['腰臀比']),
                            sit_ups_1m: Number(row['一分鐘仰臥起坐(次)']), walk_6m: Number(row['六分鐘行走測驗(m)']),
                            flexibility: Number(row['柔軟度(cm)']), sit_stand_30s: Number(row['30秒坐站測驗(次)'])
                        }));
                        setData(processData(sheetData));
                        setIsLoggedIn(true); // 設定為已登入
                    } else {
                        alert("登入失敗"); // 簡潔提示
                    }
                } catch (err) {
                    console.error(err);
                    alert("登入失敗");
                } finally {
                    setIsLoading(false);
                }
            };

            // --- 新增：如果未登入，顯示登入畫面 ---
            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen bg-slate-800 flex items-center justify-center p-4">
                        <div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
                            <div className="text-center mb-6">
                                <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i className="fas fa-heartbeat text-4xl text-blue-600"></i>
                                </div>
                                <h1 className="text-2xl font-bold text-gray-800">OT 運動追蹤系統</h1>
                            </div>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div>
                                    <input 
                                        type="password" 
                                        placeholder="請輸入密碼" 
                                        className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                                        value={apiPass}
                                        onChange={(e) => setApiPass(e.target.value)}
                                        autoFocus
                                    />
                                </div>
                                <button 
                                    type="submit" 
                                    disabled={isLoading}
                                    className={`w-full py-3 rounded-lg font-bold text-white shadow transition-all ${isLoading ? 'bg-gray-400' : 'bg-blue-600 hover:bg-blue-700'}`}
                                >
                                    {isLoading ? "驗證中..." : "登入"}
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }
            return (
                <div className="min-h-screen pb-10">
                    <nav className="bg-slate-800 text-white shadow-lg sticky top-0 z-50 no-print">
                        <div className="container mx-auto px-4 flex justify-between items-center h-16">
                            <h1 className="text-xl font-bold flex items-center"><i className="fas fa-heartbeat text-red-400 mr-2"></i>職能治療運動追蹤系統</h1>
                            <div className="flex space-x-1">
                                {[{id:'population',l:'族群概況',i:'fa-users'},{id:'individual',l:'個案報告',i:'fa-file-medical'},{id:'entry',l:'資料輸入',i:'fa-edit'}].map(t => (
                                    <button key={t.id} onClick={()=>setCurrentPage(t.id)} className={`px-4 py-2 rounded transition flex items-center ${currentPage===t.id?'bg-blue-600 text-white':'text-gray-300 hover:bg-slate-700'}`}><i className={`fas ${t.i} mr-2`}></i>{t.l}</button>
                                ))}
                            </div>
                        </div>
                    </nav>
                    <main className="container mx-auto mt-8 px-4">
                        {isLoading ? (
                            <div className="text-center py-20 text-blue-600">
                                <i className="fas fa-cloud-download-alt text-4xl mb-4 animate-bounce"></i>
                                <p className="font-bold">正在從 Google Sheets 雲端下載資料...</p>
                                <p className="text-sm text-gray-400 mt-2">連線網址: ...RUjxEWA/exec</p>
                            </div>
                        ) : (
                            data.length === 0 ? <div className="text-center py-20 text-gray-500">尚無資料，請前往「資料輸入」新增一筆。</div> :
                            currentPage === 'population' ? <PopulationView /> : currentPage === 'individual' ? <IndividualReportView /> : <DataEntryView />
                        )}
                    </main>
                </div>
            );
        }; 

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
