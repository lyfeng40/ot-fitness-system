<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>職能治療運動追蹤系統 Occupational Therapy Fitness Tracker</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .print-area { background: white; }
        
        @media print {
            .no-print { display: none !important; }
            .print-area { padding: 0 !important; margin: 0 !important; width: 100% !important; }
            body { background-color: white; }
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        /* PDF 專用頁面容器設定 */
        .pdf-page {
            height: 275mm; /* 固定高度防止溢出 */
            width: 100%;
            overflow: hidden;
            page-break-after: always;
            position: relative;
            background: white;
        }
        .pdf-page:last-child {
            page-break-after: auto;
        }
        
        /* 互動圖表按鈕樣式 */
        .chart-btn {
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
        }
        .chart-btn.active {
            background-color: #86efac;
            border-color: #16a34a;
            font-weight: 500;
        }
        .chart-btn .indicator {
            height: 4px;
            width: 20px;
            display: inline-block;
            margin-left: 6px;
            border-radius: 2px;
        }
        
        /* 下拉選單 */
        .dropdown-content { display: none; position: absolute; background-color: white; min-width: 200px; box-shadow: 0px 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; border-radius: 0.5rem; z-index: 20; max-height: 250px; overflow-y: auto; }
        .dropdown:hover .dropdown-content { display: block; }
    </style>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- 登入控制元件 (唯一新增) ---
        const LoginWrapper = () => {
            const [password, setPassword] = useState("");
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const CORRECT_PASSWORD = "8888"; // 設定密碼

            const handleLogin = (e) => {
                e.preventDefault();
                if (password === CORRECT_PASSWORD) {
                    setIsLoggedIn(true);
                } else {
                    alert("密碼錯誤");
                    setPassword("");
                }
            };

            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-900">
                        <form onSubmit={handleLogin} className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
                            <i className="fas fa-lock text-slate-400 text-4xl mb-4"></i>
                            <h2 className="text-xl font-bold mb-6 text-gray-800">系統登入</h2>
                            <input 
                                type="password" 
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="w-full border-2 border-gray-200 rounded-lg px-4 py-3 mb-4 focus:border-blue-500 outline-none transition"
                                placeholder="請輸入密碼"
                                autoFocus
                            />
                            <button 
                                type="submit"
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition"
                            >
                                進入系統
                            </button>
                        </form>
                    </div>
                );
            }

            return <Dashboard />;
        };

        // --- 圖表元件 ---
        const ChartComponent = ({ type, data, options }) => {
            const canvasRef = useRef(null);
            const chartInstanceRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || !window.Chart) return;
                if (chartInstanceRef.current) chartInstanceRef.current.destroy();

                try {
                    const ctx = canvasRef.current.getContext('2d');
                    chartInstanceRef.current = new window.Chart(ctx, { type, data, options: options || {} });
                } catch (err) { console.error(err); }
                return () => { if (chartInstanceRef.current) chartInstanceRef.current.destroy(); };
            }, [type, data, options]);

            return <canvas ref={canvasRef} />;
        };

        const Line = (props) => <ChartComponent type="line" {...props} />;
        const Radar = (props) => <ChartComponent type="radar" {...props} />;

        // --- 互動式圖表容器 ---
        const InteractiveChart = ({ title, datasets, labels, initialSelected = [] }) => {
            const [selectedKeys, setSelectedKeys] = useState(initialSelected.length > 0 ? initialSelected : datasets.map(d => d.label));

            const toggleKey = (key) => {
                setSelectedKeys(prev => prev.includes(key) ? prev.filter(k => k !== key) : [...prev, key]);
            };

            const chartData = {
                labels: labels,
                datasets: datasets.filter(d => selectedKeys.includes(d.label))
            };

            return (
                <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 h-full flex flex-col">
                    <h3 className="text-lg font-bold text-gray-700 mb-3 text-center">{title}</h3>
                    <div className="flex flex-wrap gap-2 mb-2 justify-center">
                        {datasets.map(d => (
                            <button 
                                key={d.label} 
                                onClick={() => toggleKey(d.label)}
                                className={`chart-btn px-3 py-1 rounded-md text-sm flex items-center ${selectedKeys.includes(d.label) ? 'active' : 'bg-white text-gray-600'}`}
                            >
                                {d.label}
                                <span className="indicator" style={{ backgroundColor: d.borderColor }}></span>
                            </button>
                        ))}
                    </div>
                    <div className="flex-grow min-h-[200px] relative">
                        {selectedKeys.length > 0 ? <Line data={chartData} options={{ maintainAspectRatio: false, plugins: { legend: { display: false } } }} /> 
                        : <div className="flex items-center justify-center h-full text-gray-400 text-sm">請點擊上方按鈕選擇顯示項目</div>}
                    </div>
                </div>
            );
        };

        // --- 邏輯與標準 ---
        const calcAge = (dob) => { if(!dob) return 0; const d = new Date(dob); return new Date().getFullYear() - d.getFullYear(); };
        const calcBMI = (h, w) => (!h || !w) ? 0 : w / Math.pow(h / 100, 2);
        const calcSMI = (h, w, mp) => (!h || !w || !mp) ? 0 : (w * mp / 100) / Math.pow(h / 100, 2);
        const calc6MWTPredicted = (sex, age, h, w) => (sex === "女") ? 2.11*h - 2.29*w - 5.78*age + 667 : 7.57*h - 1.76*w - 5.02*age - 309;
        
        const getBodyFatStatus = (sex, val) => {
            if (sex === "男") {
                if (val < 10) return "低";
                if (val < 20) return "標準";
                if (val < 25) return "略高";
                return "高";
            } else {
                if (val < 20) return "低";
                if (val < 30) return "標準";
                if (val < 35) return "略高";
                return "高";
            }
        };

        const getMuscleStatus = (sex, val) => {
            if (sex === "男") {
                if (val < 32.9) return "低";
                if (val < 35.8) return "標準";
                if (val < 37.4) return "略高";
                return "高";
            } else {
                if (val < 25.9) return "低";
                if (val < 28) return "標準";
                if (val < 29.1) return "略高";
                return "高";
            }
        };

        const getVisceralFatStatus = (val) => {
            if (val <= 9) return "標準";
            if (val <= 14) return "略高";
            return "高";
        };

        const getSitStandTarget = (sex, age) => {
            if (age >= 3 && age <= 9) return sex === "男" ? 23.1 : 23.4;
            if (age >= 10 && age <= 19) return sex === "男" ? 25.5 : 24.3;
            if (age >= 20 && age <= 59) return sex === "男" ? 24.2 : 22.6;
            if (age >= 60) return sex === "男" ? 18.3 : 15.9;
            return 15;
        };

        const getBMRTarget = (sex, age) => {
            if (sex === '男') {
                if (age >= 15 && age <= 17) return 1570;
                if (age >= 18 && age <= 29) return 1520;
                if (age >= 30 && age <= 49) return 1520;
                if (age >= 50 && age <= 69) return 1380;
                if (age >= 70) return 1230;
            } else {
                if (age >= 15 && age <= 17) return 1270;
                if (age >= 18 && age <= 29) return 1180;
                if (age >= 30 && age <= 49) return 1140;
                if (age >= 50 && age <= 69) return 1100;
                if (age >= 70) return 1030;
            }
            return 1200;
        };

        const getFitnessRating = (type, sex, age, val) => {
            let base = 0;
            if (type === 'sit_ups') {
                if (sex === '男') base = age < 30 ? 35 : age < 40 ? 30 : age < 50 ? 25 : age < 60 ? 20 : 15;
                else base = age < 30 ? 27 : age < 40 ? 22 : age < 50 ? 17 : age < 60 ? 13 : 8;
            } else {
                if (sex === '男') base = age < 30 ? 28 : age < 40 ? 24 : age < 50 ? 18 : age < 60 ? 15 : 12;
                else base = age < 30 ? 33 : age < 40 ? 30 : age < 50 ? 27 : age < 60 ? 25 : 22;
            }
            if (val < base * 0.6) return { s: "不好", c: "text-red-600" };
            if (val < base * 0.8) return { s: "稍差", c: "text-orange-600" };
            if (val < base * 1.2) return { s: "適當", c: "text-blue-600" };
            if (val < base * 1.4) return { s: "良好", c: "text-green-600" };
            return { s: "很好", c: "text-green-700 font-bold" };
        };

        const getStandard = (type, val, sex, age) => {
            if (type === 'sit_stand') {
                const target = getSitStandTarget(sex, age);
                if (val < target) return { status: `低於標準(${target})`, color: 'text-red-600' };
                return { status: "標準", color: 'text-green-600' };
            }
            if (type === 'walk') return { status: "-", color: "" };
            if (type === 'sit_ups') {
                const r = getFitnessRating('sit_ups', sex, age, val);
                return { status: r.s, color: r.c };
            }
            if (type === 'flexibility') {
                const r = getFitnessRating('flexibility', sex, age, val);
                return { status: r.s, color: r.c };
            }
            return { status: "-", color: "" };
        };

        const getBMIStatus = (bmi) => bmi < 18.5 ? "體重太輕" : bmi < 24 ? "標準體重" : bmi < 27 ? "過重" : bmi < 30 ? "輕度肥胖" : bmi < 35 ? "中度肥胖" : "重度肥胖";
        const getSarcopeniaStatus = (sex, smi) => (sex === "男" && smi < 7.0) || (sex === "女" && smi < 5.7) ? "肌少症" : "正常";
        const getWHRStatus = (sex, v) => (sex === "男" && v < 0.92) || (sex === "女" && v < 0.88) ? "標準" : "過高";
        const normalizeScore = (val, target, type = 'higher_better') => {
            if (!val || !target) return 0;
            let score = type === 'higher_better' ? (val / target) * 100 : val <= target ? 100 : (target / val) * 100;
            return Math.min(Math.max(score, 10), 120);
        };

        // --- 主程式 Dashboard ---
        const Dashboard = () => {
            const [data, setData] = useState([]);
            const [currentPage, setCurrentPage] = useState('population');
            
            const processData = (rawData) => {
                return rawData.map(row => {
                    const bmi = calcBMI(row.height, row.weight);
                    const smi = calcSMI(row.height, row.weight, row.muscle_percent);
                    const whr = (row.waist && row.hip) ? row.waist / row.hip : 0;
                    const predicted6m = calc6MWTPredicted(row.sex, row.age, row.height, row.weight);
                    const bmrTarget = getBMRTarget(row.sex, row.age);
                    const bmrStatus = (row.bmr < bmrTarget * 0.9) ? "偏低" : (row.bmr > bmrTarget * 1.1) ? "偏高" : "標準";
                    return {
                        ...row,
                        bmi: parseFloat(bmi.toFixed(1)),
                        smi: parseFloat(smi.toFixed(1)),
                        whr: parseFloat(whr.toFixed(1)),
                        predicted_walk_6m: parseFloat(predicted6m.toFixed(0)),
                        bmi_status: getBMIStatus(bmi),
                        sapi_status: getSarcopeniaStatus(row.sex, smi),
                        sarcopenia_status: getSarcopeniaStatus(row.sex, smi),
                        visceral_status: getVisceralFatStatus(row.visceral_fat),
                        body_fat_status: getBodyFatStatus(row.sex, row.body_fat),
                        muscle_status: getMuscleStatus(row.sex, row.muscle_percent),
                        whr_status: getWHRStatus(row.sex, whr),
                        bmr_status: bmrStatus
                    };
                });
            };

            const generateMockData = () => {
                const names = ["張大明", "李小華", "王志明", "陳淑芬", "林建國"];
                const mock = [];
                names.forEach((name, idx) => {
                    const bed = `${200 + idx}`;
                    const sex = idx % 2 === 0 ? "男" : "女";
                    const birthYear = 1960 + idx * 5; 
                    const dob = `${birthYear}-05-15`;
                    for (let i = 1; i <= 4; i++) {
                        const age = 2024 - birthYear + Math.floor((i-1)/2); 
                        const h = 160 + (sex==="男"?10:0) + Math.random()*2;
                        const w = 60 + Math.random()*5 + (i % 2 === 0 ? -1 : 1);
                        mock.push({
                            id: `${idx}_${i}`, name, sex, session: i, bed_number: bed,
                            date: `202${3+Math.floor((i-1)/2)}-${(i-1)%2===0?'03':'09'}-15`,
                            dob, age, height: h, weight: w, waist: 80+Math.random()*2, hip: 95+Math.random()*2,
                            body_fat: 25+Math.random()*3, muscle_percent: 30+Math.random()*2, visceral_fat: 8+Math.random()*3,
                            body_age: age + 5, bmr: 1350 + Math.random()*100,
                            sit_stand_30s: 10 + i + Math.floor(Math.random()*2),
                            walk_6m: 350 + i*15, flexibility: 10 + i, sit_ups_1m: 12 + i
                        });
                    }
                });
                return processData(mock);
            };

            useEffect(() => { setData(generateMockData()); }, []);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const wb = XLSX.read(evt.target.result, { type: 'binary' });
                        const jsonData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                        const mapped = jsonData.map((row, idx) => ({
                            id: `import_${idx}`, name: row['姓名'], bed_number: row['床號'], sex: row['性別']||'男',
                            session: row['次數'] || 1, date: row['評估日期'], dob: row['出生年月日'],
                            height: row['身高'], weight: row['體重'], waist: row['腰圍'], hip: row['臀圍'],
                            body_fat: row['體脂率'], muscle_percent: row['骨骼肌'], visceral_fat: row['內臟脂肪'],
                            body_age: row['體年齡'], bmr: row['基礎代謝'],
                            sit_stand_30s: row['30秒坐站'], walk_6m: row['六分鐘行走'],
                            flexibility: row['柔軟度'], sit_ups_1m: row['仰臥起坐']
                        }));
                        const calculatedData = mapped.map(d => ({ ...d, age: calcAge(d.dob) }));
                        setData(prev => [...prev, ...processData(calculatedData)]);
                        alert("匯入成功！");
                    } catch (err) { alert("匯入失敗"); }
                };
                reader.readAsBinaryString(file);
            };

            const PopulationView = () => {
                const allDates = [...new Set(data.map(d => d.date))].sort();
                const [selectedDates, setSelectedDates] = useState(allDates);
                const toggleDate = (d) => setSelectedDates(prev => prev.includes(d) ? prev.filter(x=>x!==d) : [...prev,d]);
                const filteredData = data.filter(d => selectedDates.length === 0 || selectedDates.includes(d.date));
                const latestMap = new Map();
                filteredData.forEach(d => {
                    const key = `${d.name}_${d.dob}`;
                    if (!latestMap.has(key) || new Date(d.date) > new Date(latestMap.get(key).date)) {
                        latestMap.set(key, d);
                    }
                });
                const latestRecords = Array.from(latestMap.values());
                const totalPeople = latestRecords.length;
                const males = latestRecords.filter(d => d.sex === '男').length;
                const avgAge = totalPeople ? (latestRecords.reduce((a,b) => a + b.age, 0) / totalPeople).toFixed(1) : 0;
                const riskSarcopenia = latestRecords.filter(d => d.sarcopenia_status === '肌少症').length;
                const riskVisceral = latestRecords.filter(d => d.visceral_status !== '標準').length;
                const riskObesity = latestRecords.filter(d => ['中度肥胖', '重度肥胖', '過重'].includes(d.bmi_status)).length;
                const riskFlexibility = latestRecords.filter(d => d.flexibility < 20).length;
                const datesForChart = selectedDates.length > 0 ? selectedDates.sort() : allDates;
                const getAvg = (date, field) => {
                    const dayData = data.filter(d => d.date === date);
                    return dayData.length ? parseFloat((dayData.reduce((a,b)=>a+(b[field]||0),0)/dayData.length).toFixed(1)) : 0;
                };
                const bodyDatasets = [
                    { label: '體重', data: datesForChart.map(d=>getAvg(d,'weight')), borderColor: '#ef4444' }, 
                    { label: 'BMI', data: datesForChart.map(d=>getAvg(d,'bmi')), borderColor: '#8b5cf6' },
                    { label: '骨骼肌', data: datesForChart.map(d=>getAvg(d,'muscle_percent')), borderColor: '#10b981' },
                    { label: '體脂率', data: datesForChart.map(d=>getAvg(d,'body_fat')), borderColor: '#f59e0b' },
                    { label: '內臟脂肪', data: datesForChart.map(d=>getAvg(d,'visceral_fat')), borderColor: '#2563eb' }
                ];
                const fitnessDatasets = [
                    { label: '6分鐘行走', data: datesForChart.map(d=>getAvg(d,'walk_6m')), borderColor: '#8b5cf6' },
                    { label: '30秒坐站', data: datesForChart.map(d=>getAvg(d,'sit_stand_30s')), borderColor: '#ec4899' },
                    { label: '仰臥起坐', data: datesForChart.map(d=>getAvg(d,'sit_ups_1m')), borderColor: '#f59e0b' },
                    { label: '柔軟度', data: datesForChart.map(d=>getAvg(d,'flexibility')), borderColor: '#06b6d4' }
                ];
                return (
                    <div className="space-y-6 animate-fade-in pb-12">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                            <h2 className="text-xl font-bold text-gray-800 mb-4 border-b pb-2">全體學員健康風險儀表板</h2>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                <div className="text-center p-3 bg-gray-50 rounded"><p className="text-gray-500 text-sm">總評估人數</p><p className="text-2xl font-bold">{totalPeople} 人</p></div>
                                <div className="text-center p-3 bg-gray-50 rounded"><p className="text-gray-500 text-sm">男女比例</p><p className="text-2xl font-bold text-blue-600">{males} : <span className="text-pink-500">{totalPeople-males}</span></p></div>
                                <div className="text-center p-3 bg-gray-50 rounded"><p className="text-gray-500 text-sm">平均年齡</p><p className="text-2xl font-bold">{avgAge} 歲</p></div>
                                <div className="text-center p-3 bg-gray-50 rounded relative dropdown group cursor-pointer">
                                    <p className="text-gray-500 text-sm mb-1">評估日期篩選 (可複選) ▾</p>
                                    <div className="font-bold text-lg text-blue-600">{selectedDates.length} 個</div>
                                    <div className="dropdown-content left-0 right-0 mx-auto">
                                        {allDates.map(d => (
                                            <label key={d} className="flex items-center space-x-2 p-2 hover:bg-gray-100 cursor-pointer text-left text-sm border-b">
                                                <input type="checkbox" checked={selectedDates.includes(d)} onChange={() => toggleDate(d)} className="form-checkbox h-4 w-4 text-blue-600" />
                                                <span>{d}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                {[
                                    { t: "肌少症風險", c: riskSarcopenia, color: "orange" }, { t: "內臟脂肪過高", c: riskVisceral, color: "red" },
                                    { t: "BMI肥胖/過重", c: riskObesity, color: "blue" }, { t: "柔軟度不佳", c: riskFlexibility, color: "purple" }
                                ].map((r, i) => (
                                    <div key={i} className={`p-4 rounded-lg border-l-4 shadow-sm bg-white border-${r.color}-500`}>
                                        <h3 className="text-gray-500 text-sm">{r.t}</h3>
                                        <div className="flex items-end gap-2 mt-1"><span className="text-2xl font-bold">{r.c}</span><span className="text-sm text-gray-400">/ {totalPeople} ({totalPeople?Math.round(r.c/totalPeople*100):0}%)</span></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <InteractiveChart title="身體素質平均分析" datasets={bodyDatasets} labels={datesForChart} />
                            <InteractiveChart title="體能表現平均分析" datasets={fitnessDatasets} labels={datesForChart} />
                        </div>
                    </div>
                );
            };

            const IndividualReportView = () => {
                const uniquePeople = useMemo(() => {
                    const map = new Map();
                    data.forEach(d => {
                        const key = `${d.name}_${d.dob}`;
                        if (!map.has(key)) map.set(key, d);
                    });
                    return Array.from(map.values()).sort((a,b) => a.name.localeCompare(b.name));
                }, [data]);
                const [selKey, setSelKey] = useState("");
                const [selDate, setSelDate] = useState("");
                useEffect(() => { if (uniquePeople.length > 0 && !selKey) setSelKey(`${uniquePeople[0].name}_${uniquePeople[0].dob}`); }, [uniquePeople]);
                const personRecords = useMemo(() => {
                    if (!selKey) return [];
                    const [n, d] = selKey.split('_');
                    return data.filter(r => r.name === n && r.dob === d).sort((a,b) => new Date(a.date) - new Date(b.date));
                }, [selKey, data]);
                const availableDates = personRecords.map(r => r.date);
                useEffect(() => { if(availableDates.length > 0 && !availableDates.includes(selDate)) setSelDate(availableDates[availableDates.length-1]); }, [selKey, personRecords]);
                const current = personRecords.find(r => r.date === selDate) || {};
                const radarScores = current.id ? [
                    normalizeScore(current.bmi, 22, 'lower_better'), normalizeScore(current.smi, 7.0, 'higher_better'),
                    normalizeScore(current.walk_6m, current.predicted_walk_6m, 'higher_better'), normalizeScore(current.sit_stand_30s, 15, 'higher_better'),
                    normalizeScore(current.flexibility, 30, 'higher_better'), normalizeScore(current.sit_ups_1m, 25, 'higher_better'),
                ] : [0,0,0,0,0,0];
                const fitnessScore = (radarScores[2] + radarScores[3] + radarScores[4] + radarScores[5]) / 4;
                const bodyScore = (radarScores[0] + radarScores[1]) / 2;
                const compositeScore = Math.round(fitnessScore * 0.6 + bodyScore * 0.4);
                const radarData = { labels: ['BMI', 'SMI', '心肺', '下肢', '柔軟度', '核心'], datasets: [{ label: '分數', data: radarScores, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 2 }] };
                const sitStandStd = getStandard('sit_stand', current.sit_stand_30s, current.sex, current.age);
                const flexStd = getStandard('flexibility', current.flexibility, current.sex, current.age);
                const sitUpsStd = getStandard('sit_ups', current.sit_ups_1m, current.sex, current.age);
                const walkStd = current.walk_6m < current.predicted_walk_6m ? {s: `低於預測(${current.predicted_walk_6m})`, c: 'text-red-600'} : {s: "佳", c: 'text-green-600'};
                const otAnalysis = compositeScore >= 80 ? '優良' : compositeScore >= 60 ? '尚可' : '待加強'; // 簡化展示
                const downloadPDF = () => {
                    const el = document.getElementById('report-container');
                    const opt = { margin: 5, filename: `${current.name}_完整報告.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 4, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                    html2pdf().from(el).set(opt).save();
                };
                const dates = personRecords.map(r=>r.date);
                if(!current.id) return <div className="p-10 text-center">請先匯入資料</div>;
                return (
                    <div className="pb-10">
                        <div className="bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-wrap gap-4 items-center justify-between no-print">
                            <div className="flex gap-4 items-center">
                                <label className="font-bold">學員: 
                                    <select className="border rounded p-1" value={selKey} onChange={e => setSelKey(e.target.value)}>
                                        {uniquePeople.map(p => <option key={`${p.name}_${p.dob}`} value={`${p.name}_${p.dob}`}>{p.name} ({p.dob})</option>)}
                                    </select>
                                </label>
                                <label className="font-bold">日期: 
                                    <select className="border rounded p-1" value={selDate} onChange={e => setSelDate(e.target.value)}>
                                        {availableDates.map(d=><option key={d} value={d}>{d}</option>)}
                                    </select>
                                </label>
                            </div>
                            <button onClick={downloadPDF} className="bg-blue-600 text-white px-4 py-2 rounded shadow"><i className="fas fa-print mr-2"></i>下載/列印</button>
                        </div>
                        <div id="report-container" className="max-w-[210mm] mx-auto bg-white shadow-lg">
                            <div className="pdf-page p-8 flex flex-col items-stretch">
                                <div className="border-b-4 border-blue-600 pb-2 mb-2 text-center">
                                    <h1 className="text-3xl font-bold text-gray-800">體適能評估與介入建議書</h1>
                                </div>
                                <div className="bg-blue-50 p-2 rounded mb-2 grid grid-cols-5 gap-2 text-center text-sm border border-blue-100">
                                    <div><p className="text-gray-500 text-xs">評估日期</p><b>{current.date}</b></div>
                                    <div><p className="text-gray-500 text-xs">床號</p><b>{current.bed_number||"未填"}</b></div>
                                    <div><p className="text-gray-500 text-xs">姓名</p><b className="text-lg">{current.name}</b></div>
                                    <div><p className="text-gray-500 text-xs">性別/年齡</p><b>{current.sex} / {current.age}歲</b></div>
                                    <div><p className="text-gray-500 text-xs">出生年月日</p><b>{current.dob||"未填"}</b></div>
                                </div>
                                <div className="grid grid-cols-2 gap-4 mb-2 flex-grow items-stretch">
                                    <div className="flex flex-col h-full bg-white border rounded p-2 border-gray-200">
                                        <h3 className="bg-gray-800 text-white text-center text-sm py-1 font-bold rounded-t mb-2">身體素質表現</h3>
                                        <table className="w-full text-xs border border-gray-300 text-center mb-2">
                                            <thead className="bg-gray-100"><tr><th className="border p-1">項目</th><th className="border p-1">數值</th><th className="border p-1">標準</th></tr></thead>
                                            <tbody>
                                                <tr><td className="border p-1">BMI</td><td className="border p-1">{current.bmi}</td><td className="border p-1">{current.bmi_status}</td></tr>
                                                <tr><td className="border p-1">骨骼肌(%)</td><td className="border p-1">{current.muscle_percent}%</td><td className="border p-1">{current.muscle_status}</td></tr>
                                                <tr><td className="border p-1">SMI</td><td className="border p-1">{current.smi}</td><td className="border p-1">{current.sarcopenia_status}</td></tr>
                                            </tbody>
                                        </table>
                                        <div className="mt-1 flex-grow flex flex-col items-center justify-center border rounded p-2 relative">
                                            <Radar data={radarData} options={{ maintainAspectRatio: false, plugins: { legend: { display: false } } }} />
                                            <div className="text-4xl font-bold text-blue-600 text-center">{compositeScore}</div>
                                        </div>
                                    </div>
                                    <div className="flex flex-col h-full bg-white border rounded p-2 border-gray-200">
                                        <h3 className="bg-gray-800 text-white text-center text-sm py-1 font-bold rounded-t mb-2">體能表現評估</h3>
                                        <table className="w-full text-xs border border-gray-300 text-center mb-2">
                                            <thead className="bg-gray-100"><tr><th className="border p-1">項目</th><th className="border p-1">數值</th><th className="border p-1">評語</th></tr></thead>
                                            <tbody>
                                                <tr><td className="border p-1">30秒坐站</td><td className="border p-1">{current.sit_stand_30s}次</td><td className={sitStandStd.color}>{sitStandStd.status}</td></tr>
                                                <tr><td className="border p-1">6分鐘行走</td><td className="border p-1">{current.walk_6m}m</td><td className={walkStd.c}>{walkStd.s}</td></tr>
                                            </tbody>
                                        </table>
                                        <div className="mt-auto bg-orange-50 p-2 rounded flex-grow text-[11px]">
                                            <h4 className="font-bold text-orange-800 mb-1 border-b">OT 綜合建議</h4>
                                            <p>整體表現：{otAnalysis}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const DataEntryView = () => {
                const [form, setForm] = useState({ 
                    date: new Date().toISOString().split('T')[0], bed_number: '', name: '', 
                    dob: '', age: '', sex: '男', height: '', weight: '', waist: '', hip: '', 
                    body_fat: '', muscle_percent: '', visceral_fat: '', body_age: '', bmr: '',
                    sit_stand_30s: '', walk_6m: '', flexibility: '', sit_ups_1m: '' 
                });
                const handleChange = (e) => {
                    const { name, value } = e.target;
                    let newForm = { ...form, [name]: value };
                    if (name === 'dob') newForm.age = calcAge(value);
                    setForm(newForm);
                };
                const handleSubmit = (e) => {
                    e.preventDefault();
                    setData(prev => [...prev, ...processData([{...form, id: Date.now(), age: parseInt(form.age)}])]);
                    alert("新增成功");
                };
                return (
                    <div className="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-sm">
                        <div className="flex justify-between items-center mb-6 border-b pb-4">
                            <h2 className="text-2xl font-bold text-gray-800">資料輸入 / 匯入</h2>
                            <label className="cursor-pointer bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow transition">
                                <i className="fas fa-file-excel mr-2"></i>Excel 批次匯入
                                <input type="file" accept=".xlsx, .xls" className="hidden" onChange={handleFileUpload} />
                            </label>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <label className="block text-sm">姓名 <input required name="name" value={form.name} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                <label className="block text-sm">床號 <input name="bed_number" value={form.bed_number} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                <label className="block text-sm">身高 <input required type="number" name="height" value={form.height} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                                <label className="block text-sm">體重 <input required type="number" name="weight" value={form.weight} onChange={handleChange} className="w-full border p-2 rounded" /></label>
                            </div>
                            <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold shadow">新增一筆資料</button>
                        </form>
                    </div>
                );
            };

            return (
                <div className="min-h-screen pb-10">
                    <nav className="bg-slate-800 text-white shadow-lg sticky top-0 z-50 no-print">
                        <div className="container mx-auto px-4 flex justify-between items-center h-16">
                            <h1 className="text-xl font-bold flex items-center"><i className="fas fa-heartbeat text-red-400 mr-2"></i>職能治療運動追蹤系統</h1>
                            <div className="flex space-x-1">
                                {[{id:'population',l:'族群概況',i:'fa-users'},{id:'individual',l:'個案報告',i:'fa-file-medical'},{id:'entry',l:'資料輸入',i:'fa-edit'}].map(t => (
                                    <button key={t.id} onClick={()=>setCurrentPage(t.id)} className={`px-4 py-2 rounded transition flex items-center ${currentPage===t.id?'bg-blue-600 text-white':'text-gray-300 hover:bg-slate-700'}`}><i className={`fas ${t.i} mr-2`}></i>{t.l}</button>
                                ))}
                            </div>
                        </div>
                    </nav>
                    <main className="container mx-auto mt-8 px-4">
                        {data.length === 0 ? <div className="text-center py-20 text-gray-500"><i className="fas fa-spinner fa-spin text-4xl mb-4"></i><p>資料初始化中...</p></div> : 
                            currentPage === 'population' ? <PopulationView /> : currentPage === 'individual' ? <IndividualReportView /> : <DataEntryView />
                        }
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LoginWrapper />); // 入口點改為 LoginWrapper
    </script>
</body>
</html>
