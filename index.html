<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT 職能治療運動評估系統</title>
    
    <!-- 1. 引入 Tailwind CSS (美化樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. 引入 Babel (讓瀏覽器看懂 React 語法) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. 引入圖表庫 Recharts -->
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
    
    <!-- 5. 引入圖標庫 Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <!-- 這裡開始是主要的程式邏輯 -->
    <script type="text/babel">
        // --- 設定環境變數 ---
        const { useState, useMemo, useEffect } = React;
        
        // 從全域變數獲取 Recharts 組件
        const { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer,
            RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar 
        } = window.Recharts;

        // 從全域變數獲取 Lucide 圖標
        const { 
            User, Activity, Clipboard, Download, PlusCircle, Database, 
            Calendar, PieChart, Info, Heart, Coffee, Users 
        } = window.lucideReact;

        // --- 輔助函數 ---
        const calculateAge = (birthday) => {
            if (!birthday) return 0;
            const birthDate = new Date(birthday);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
            return age;
        };

        const getSitupsLevel = (count, gender, age) => {
            if (gender === '男') {
                if (count >= 45) return { text: "很好", color: "text-blue-600" };
                if (count >= 35) return { text: "良好", color: "text-blue-600" };
                if (count >= 25) return { text: "適當", color: "text-blue-600" };
                if (count >= 15) return { text: "稍差", color: "text-red-600" };
                return { text: "不好", color: "text-red-600" };
            } else {
                if (count >= 35) return { text: "很好", color: "text-blue-600" };
                if (count >= 25) return { text: "良好", color: "text-blue-600" };
                if (count >= 15) return { text: "適當", color: "text-blue-600" };
                if (count >= 10) return { text: "稍差", color: "text-red-600" };
                return { text: "不好", color: "text-red-600" };
            }
        };

        const getDetailedEvaluation = (m, gender, age) => {
            if (!m || !m.data || m.data.length === 0) return null;
            const d = m.data[m.data.length - 1];
            const h_m = d.height / 100;
            const bmi = (d.weight / (h_m * h_m)).toFixed(1);
            const sMM_weight = (d.weight * d.sMM / 100).toFixed(1);
            const smi = (sMM_weight / (h_m * h_m)).toFixed(2);
            const whr = (d.waist / d.hip).toFixed(2);

            // BMI
            const bmiMax = (24 * h_m * h_m).toFixed(1);
            const bmiMin = (18.5 * h_m * h_m).toFixed(1);
            let bmiEval = { text: "標準", color: "text-blue-600" };
            if (bmi < 18.5) bmiEval = { text: "低於標準", color: "text-red-600" };
            else if (bmi >= 24) bmiEval = { text: "高於標準", color: "text-red-600" };

            // 體脂
            const fatLimit = gender === "男" ? 20 : 30;
            const fatEval = d.bodyFat > fatLimit ? { text: "高於標準", color: "text-red-600" } : { text: "標準", color: "text-blue-600" };

            // 骨骼肌
            const smmMin = gender === "男" ? 32.9 : 25.9;
            const smmEval = d.sMM < smmMin ? { text: "低於標準", color: "text-red-600" } : { text: "標準", color: "text-blue-600" };

            // SMI
            const smiLimit = gender === "男" ? 7.0 : 5.7;
            const smiEval = smi < smiLimit ? { text: "低於標準", color: "text-red-600" } : { text: "標準", color: "text-blue-600" };

            // 內脂
            const vfEval = d.visceralFat >= 10 ? { text: "高於標準", color: "text-red-600" } : { text: "標準", color: "text-blue-600" };

            // 腰臀比
            const whrStd = gender === "男" ? 0.92 : 0.88;
            const whrEval = whr > whrStd ? { text: "高於標準", color: "text-red-600" } : { text: "標準", color: "text-blue-600" };

            // 30秒坐站
            const sitStandStd = gender === "男" ? (age >= 60 ? 18 : 24) : (age >= 60 ? 15 : 22);
            const sitStandEval = d.sitStand < sitStandStd ? { text: "低於標準", color: "text-red-600" } : { text: "標準", color: "text-blue-600" };

            // 六分鐘行走
            const walkPredict = gender === "女" ? (2.11 * d.height - 2.29 * d.weight - 5.78 * age + 667) : (7.57 * d.height - 1.76 * d.weight - 5.02 * age - 309);
            const walkMin = Math.round(gender === "女" ? walkPredict - 139 : walkPredict - 153);
            const walkEval = d.walk6m < walkMin ? { text: "低於標準", color: "text-red-600" } : { text: "標準", color: "text-blue-600" };

            // 仰臥起坐與柔軟度
            const situpsEval = getSitupsLevel(d.situps, gender, age);
            const reachStd = gender === "男" ? 10 : 15;
            let reachEval = { text: "適當", color: "text-blue-600" };
            if (d.sitReach >= (reachStd + 10)) reachEval = { text: "很好", color: "text-blue-600" };
            else if (d.sitReach >= (reachStd + 5)) reachEval = { text: "良好", color: "text-blue-600" };
            else if (d.sitReach < (reachStd - 5)) reachEval = { text: "不好", color: "text-red-600" };
            else if (d.sitReach < reachStd) reachEval = { text: "稍差", color: "text-red-600" };

            // 體年齡差距
            const ageDiff = d.bodyAge - age;
            const ageDiffStr = ageDiff > 0 ? `+${ageDiff}` : `${ageDiff}`;
            const ageColor = ageDiff > 0 ? "text-red-600" : "text-blue-600";
            const ageEval = ageDiff > 0 ? { text: "高於標準", color: "text-red-600" } : { text: "標準", color: "text-blue-600" };

            return {
                bmi, bmiMin, bmiMax, bmiEval, fatLimit, fatEval, smmMin, smmEval, smi, smiLimit, smiEval,
                vfEval, whr, whrStd, whrEval, sitStandStd, sitStandEval, walkMin, walkEval,
                situpsEval, reachStd, reachEval, sMM_weight, ageDiffStr, ageColor, ageEval
            };
        };

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [selectedUserId, setSelectedUserId] = useState('');
            const [selectedDates, setSelectedDates] = useState([]);
            const [bodyMetric, setBodyMetric] = useState('weight');
            const [performanceMetric, setPerformanceMetric] = useState('walk6m');
            
            // --- 修改點：從 Google Sheets 獲取資料 ---
            const [members, setMembers] = useState([]);

            useEffect(() => {
                const API_URL = 'https://script.google.com/macros/s/AKfycbwvgn6knfLN1xgBSCA7TWSR1pP5dAGyFWe6FDZ5y6Sfu0gXyM8Ewdo26LPsS-bO-Ptmdw/exec'; // 這是你提供的 API
                
                fetch(API_URL)
                    .then(r => r.json())
                    .then(data => {
                        console.log("從 Google Sheets 獲取資料成功:", data);
                        if(Array.isArray(data) && data.length > 0) {
                            setMembers(data);
                        } else {
                            // 若沒資料，保留一個範例以免畫面全白
                            setMembers([
                                { id: "000", bed: "範例", name: "讀取中或無資料", gender: "男", birthday: "2000-01-01", data: [{ date: "2024-01-01", weight: 60, height: 170, bodyFat: 20, sMM: 30, visceralFat: 5, sitStand: 15, walk6m: 400, sitReach: 10, situps: 20, waist: 80, hip: 90, bmr: 1500, bodyAge: 25 }] }
                            ]);
                        }
                    })
                    .catch(err => console.error("資料讀取失敗", err));
            }, []);
            // ----------------------------------------

            const allDates = useMemo(() => {
                const dates = new Set();
                members.forEach(m => m.data.forEach(d => dates.add(d.date)));
                return Array.from(dates).sort();
            }, [members]);

            const sortedMembers = useMemo(() => [...members].sort((a, b) => a.id.localeCompare(b.id)), [members]);
            const selectedUser = useMemo(() => members.find(m => m.id === selectedUserId), [members, selectedUserId]);
            const evalResults = useMemo(() => selectedUser ? getDetailedEvaluation(selectedUser, selectedUser.gender, calculateAge(selectedUser.birthday)) : null, [selectedUser]);

            const filteredStats = useMemo(() => {
                let targetEntries = [];
                let memberIdsInFilter = new Set();
                let ages = [];
                let maleCount = 0;
                let femaleCount = 0;

                members.forEach(m => {
                    const age = calculateAge(m.birthday);
                    let mHasDataInDate = false;
                    m.data.forEach(d => {
                        if (selectedDates.length === 0 || selectedDates.includes(d.date)) {
                            const res = getDetailedEvaluation({ data: [d] }, m.gender, age);
                            targetEntries.push({ ...d, res, gender: m.gender });
                            mHasDataInDate = true;
                        }
                    });
                    if (mHasDataInDate) {
                        memberIdsInFilter.add(m.id);
                        ages.push(age);
                        if (m.gender === '男') maleCount++; else femaleCount++;
                    }
                });

                const total = targetEntries.length;
                const bmiAlert = targetEntries.filter(d => parseFloat(d.res.bmi) >= 27).length;
                const vfAlert = targetEntries.filter(d => d.visceralFat >= 10).length;
                const smmAlert = targetEntries.filter(d => d.sMM < 30).length;
                const smiAlert = targetEntries.filter(d => d.res.smi < d.res.smiLimit).length;
                const avgAge = ages.length > 0 ? (ages.reduce((a,b)=>a+b,0)/ages.length).toFixed(1) : 0;
                
                return {
                    total, bmiAlert, vfAlert, smmAlert, smiAlert,
                    maleCount, femaleCount, avgAge, memberTotal: memberIdsInFilter.size
                };
            }, [members, selectedDates]);

            const [newEntry, setNewEntry] = useState({
                date: new Date().toISOString().split('T')[0],
                bed: '', name: '', birthday: '', gender: '男',
                height: '', weight: '', bodyFat: '', sMM: '', bmr: '', bodyAge: '', visceralFat: '', waist: '', hip: '',
                situps: '', walk6m: '', sitStand: '', sitReach: ''
            });

            // 注意：因為沒有後端，這裡的按鈕只會在本地端 console 顯示，無法寫回 Google Sheets (需要更複雜的 POST 設定)
            const handleAddEntry = () => {
               alert("因使用純網頁版，目前僅支援讀取 Google Sheets，無法直接寫入。\n請至 Google Sheets 新增資料後重新整理網頁。");
            };

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8">
                    <header className="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-indigo-900 flex items-center gap-2">
                                <Activity className="text-indigo-600" /> 職能治療運動評估管理系統
                            </h1>
                            <p className="text-slate-500 text-sm italic">OT Supervisor Management Console</p>
                        </div>
                        <nav className="flex bg-slate-100 p-1 rounded-xl">
                            <button onClick={() => setView('dashboard')} className={`px-4 py-2 rounded-lg text-sm transition ${view === 'dashboard' ? 'bg-white shadow text-indigo-600 font-bold' : 'text-slate-500'}`}>族群分析</button>
                            <button onClick={() => setView('individual')} className={`px-4 py-2 rounded-lg text-sm transition ${view === 'individual' ? 'bg-white shadow text-indigo-600 font-bold' : 'text-slate-500'}`}>個人報告</button>
                            <button onClick={() => setView('entry')} className={`px-4 py-2 rounded-lg text-sm transition ${view === 'entry' ? 'bg-white shadow text-indigo-600 font-bold' : 'text-slate-500'}`}>資料錄入</button>
                        </nav>
                    </header>

                    {view === 'dashboard' && (
                        <div className="space-y-6">
                            <div className="bg-white p-4 rounded-xl shadow-sm border flex items-center gap-4">
                                <span className="text-sm font-bold text-slate-500 flex items-center gap-1"><Calendar size={16}/> 評估日期篩選:</span>
                                <div className="flex flex-wrap gap-2">
                                    {allDates.map(date => (
                                        <button key={date} onClick={() => setSelectedDates(prev => prev.includes(date) ? prev.filter(d => d !== date) : [...prev, date])} className={`px-3 py-1 rounded-full text-xs transition ${selectedDates.includes(date) ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-500'}`}>
                                            {date}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                                    <div className="bg-indigo-100 p-3 rounded-xl text-indigo-600"><Users size={24}/></div>
                                    <div><p className="text-xs font-bold text-slate-400">總評估人數</p><h3 className="text-xl font-black text-slate-700">{filteredStats.memberTotal} 人</h3></div>
                                </div>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                                    <div className="bg-blue-100 p-3 rounded-xl text-blue-600"><User size={24}/></div>
                                    <div><p className="text-xs font-bold text-slate-400">男女比例 (男/女)</p><h3 className="text-xl font-black text-slate-700">{filteredStats.maleCount} / {filteredStats.femaleCount}</h3></div>
                                </div>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                                    <div className="bg-emerald-100 p-3 rounded-xl text-emerald-600"><Calendar size={24}/></div>
                                    <div><p className="text-xs font-bold text-slate-400">平均年齡</p><h3 className="text-xl font-black text-slate-700">{filteredStats.avgAge} 歲</h3></div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                <div className="bg-white p-6 rounded-2xl border-l-4 border-indigo-500 shadow-sm text-center"><p className="text-slate-500 text-xs font-bold">肥胖警示 (BMI ≥ 27)</p><h3 className="text-2xl font-black mt-1 text-indigo-900">{filteredStats.bmiAlert} / {filteredStats.total}</h3></div>
                                <div className="bg-white p-6 rounded-2xl border-l-4 border-red-500 shadow-sm text-center"><p className="text-slate-500 text-xs font-bold">內脂警示 (VF ≥ 10)</p><h3 className="text-2xl font-black mt-1 text-red-600">{filteredStats.vfAlert} / {filteredStats.total}</h3></div>
                                <div className="bg-white p-6 rounded-2xl border-l-4 border-amber-500 shadow-sm text-center"><p className="text-slate-500 text-xs font-bold">骨骼肌率低警示</p><h3 className="text-2xl font-black mt-1 text-amber-600">{filteredStats.smmAlert} / {filteredStats.total}</h3></div>
                                <div className="bg-white p-6 rounded-2xl border-l-4 border-rose-500 shadow-sm text-center"><p className="text-slate-500 text-xs font-bold">肌少風險 (SMI 警示)</p><h3 className="text-2xl font-black mt-1 text-rose-600">{filteredStats.smiAlert} / {filteredStats.total}</h3></div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div className="bg-white p-6 rounded-2xl shadow-sm border">
                                    <h3 className="font-bold text-slate-700 flex items-center gap-2 mb-6"><Database size={18}/> 身體素質平均趨勢</h3>
                                    <select value={bodyMetric} onChange={(e) => setBodyMetric(e.target.value)} className="mb-4 w-full p-2 bg-slate-50 rounded-lg text-sm border-none focus:ring-2 ring-indigo-500">
                                        <option value="weight">體重 (kg)</option><option value="bodyFat">體脂率 (%)</option><option value="sMM">骨骼肌率 (%)</option><option value="visceralFat">內臟脂肪</option><option value="bmi">BMI</option>
                                    </select>
                                    <div className="h-64"><ResponsiveContainer width="100%" height="100%"><LineChart data={[{d:'期初',v:75},{d:'期中',v:74},{d:'期末',v:72}]}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="d" /><YAxis /><Tooltip /><Line type="monotone" dataKey="v" name="平均值" stroke="#6366f1" strokeWidth={3} /></LineChart></ResponsiveContainer></div>
                                </div>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border">
                                    <h3 className="font-bold text-slate-700 flex items-center gap-2 mb-6"><Activity size={18}/> 動作表現平均趨勢</h3>
                                    <select value={performanceMetric} onChange={(e) => setPerformanceMetric(e.target.value)} className="mb-4 w-full p-2 bg-slate-50 rounded-lg text-sm border-none focus:ring-2 ring-emerald-500">
                                        <option value="walk6m">六分鐘行走</option><option value="situps">一分鐘仰臥起坐</option><option value="sitReach">柔軟度</option><option value="sitStand">30秒坐站測驗</option>
                                    </select>
                                    <div className="h-64"><ResponsiveContainer width="100%" height="100%"><LineChart data={[{d:'期初',v:320},{d:'期中',v:345},{d:'期末',v:370}]}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="d" /><YAxis /><Tooltip /><Line type="monotone" dataKey="v" name="平均值" stroke="#10b981" strokeWidth={3} /></LineChart></ResponsiveContainer></div>
                                </div>
                            </div>
                        </div>
                    )}

                    {view === 'individual' && (
                        <div className="space-y-6">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                                <span className="text-slate-500 font-bold text-sm">個案選擇:</span>
                                <select value={selectedUserId} onChange={(e) => setSelectedUserId(e.target.value)} className="flex-1 p-2 bg-slate-50 border-slate-200 rounded-xl focus:ring-2 ring-indigo-500">
                                    <option value="">-- 請選擇個案 --</option>
                                    {sortedMembers.map(m => <option key={m.id} value={m.id}>{m.id} - {m.name} (床號: {m.bed})</option>)}
                                </select>
                            </div>

                            {selectedUser && evalResults && (
                                <div id="report-content" className="space-y-8">
                                    <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 min-h-[1050px]">
                                        <div className="flex justify-between items-start mb-6">
                                            <div><h2 className="text-3xl font-bold text-slate-800">{selectedUser.name}<span className="text-lg font-normal text-slate-400 ml-4">{calculateAge(selectedUser.birthday)}歲 | {selectedUser.gender} | 評估日期: {selectedUser.data[selectedUser.data.length-1].date}</span></h2></div>
                                            <button onClick={() => window.print()} className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm flex items-center gap-2"><Download size={16}/> 導出 PDF</button>
                                        </div>

                                        <div className="mb-8">
                                            <h4 className="font-bold text-sm text-indigo-600 mb-4 flex items-center gap-2 border-b pb-2"><User size={16}/> (1) 身體素質評估</h4>
                                            <div className="grid grid-cols-5 gap-3">
                                                {[
                                                    { l: "BMI", v: evalResults.bmi, s: evalResults.bmiEval.text, h: `標準：18.5-24`, c: evalResults.bmiEval.color },
                                                    { l: "當次評估體重", v: `${selectedUser.data[selectedUser.data.length-1].weight}kg`, s: "標準", h: `標準：${evalResults.bmiMin}-${evalResults.bmiMax}kg`, c: "text-blue-600" },
                                                    { l: "體脂肪", v: `${selectedUser.data[selectedUser.data.length-1].bodyFat}%`, s: evalResults.fatEval.text, h: `標準：< ${evalResults.fatLimit}%`, c: evalResults.fatEval.color },
                                                    { l: "骨骼肌率", v: `${selectedUser.data[selectedUser.data.length-1].sMM}%`, s: evalResults.smmEval.text, h: `標準：> ${evalResults.smmMin}%`, c: evalResults.smmEval.color },
                                                    { l: "骨骼肌重量", v: `${evalResults.sMM_weight}kg`, s: "標準", h: "體重 * 骨骼肌%", c: "text-blue-600" },
                                                    { l: "SMI 索引", v: evalResults.smi, s: evalResults.smiEval.text, h: `標準：> ${evalResults.smiLimit}`, c: evalResults.smiEval.color },
                                                    { l: "內臟脂肪", v: selectedUser.data[selectedUser.data.length-1].visceralFat, s: evalResults.vfEval.text, h: "標準：1-9", c: evalResults.vfEval.color },
                                                    { l: "腰臀比", v: evalResults.whr, s: evalResults.whrEval.text, h: `標準：< ${evalResults.whrStd}`, c: evalResults.whrEval.color },
                                                    { l: "體年齡對比", v: evalResults.ageDiffStr, s: evalResults.ageEval.text, h: "體脂/代衡量", c: evalResults.ageColor },
                                                    { l: "基礎代謝", v: selectedUser.data[selectedUser.data.length-1].bmr, s: "標準", h: "kcal/日", c: "text-blue-600" }
                                                ].map((item, i) => (
                                                    <div key={i} className="p-3 rounded-xl border bg-slate-50 border-slate-100 relative flex flex-col justify-between h-24">
                                                        <div><p className="text-[10px] font-bold text-slate-400 uppercase leading-none mb-1">{item.l}</p><p className="text-xl font-black text-indigo-900 leading-tight">{item.v}</p></div>
                                                        <div className="flex justify-between items-baseline mt-auto border-t border-slate-200 pt-1"><span className={`text-xl font-black ${item.c}`}>{item.s}</span><span className="text-[9px] text-slate-400 font-bold text-right">{item.h}</span></div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-8 items-start">
                                            <div className="space-y-4">
                                                <h4 className="font-bold text-sm text-slate-600 flex items-center gap-2"><PieChart size={16}/> 體能PR雷達圖</h4>
                                                <div className="h-80 bg-slate-50 rounded-2xl border border-slate-100 flex flex-col items-center justify-center p-4">
                                                    <ResponsiveContainer width="100%" height="80%"><RadarChart data={[{subject:'BMI',v:80},{subject:'骨骼肌',v:70},{subject:'坐站',v:60},{subject:'行走',v:90},{subject:'仰臥',v:50},{subject:'柔軟度',v:40}]}><PolarGrid /><PolarAngleAxis dataKey="subject" /><Radar name="PR" dataKey="v" stroke="#6366f1" fill="#6366f1" fillOpacity={0.5} /></RadarChart></ResponsiveContainer>
                                                    <div className="text-[11px] text-indigo-700 font-bold mt-2 text-center bg-indigo-50 p-2 rounded-lg border border-indigo-100 leading-relaxed">整體 PR 面積百分比：<span className="text-lg">65%</span> <br/><span className="text-[9px] text-slate-500 font-normal">說明：數值經由全國同齡常模換算為 PR 值（0-100），面積百分比越大代表體能表現越優異。</span></div>
                                                </div>
                                            </div>
                                            <div className="space-y-4">
                                                <h4 className="font-bold text-sm text-emerald-600 flex items-center gap-2"><Activity size={16}/> (2) 體能表現評估</h4>
                                                <div className="space-y-4">
                                                    {[
                                                        { l: "核心-一分鐘仰臥起坐", v: `${selectedUser.data[selectedUser.data.length-1].situps}次`, s: evalResults.situpsEval.text, h: `標準：常模等級`, c: evalResults.situpsEval.color },
                                                        { l: "心肺-六分鐘行走 (6MWD)", v: `${selectedUser.data[selectedUser.data.length-1].walk6m}m`, s: evalResults.walkEval.text, h: `標準：> ${evalResults.walkMin}m`, c: evalResults.walkEval.color },
                                                        { l: "下肢-30秒坐站測驗", v: `${selectedUser.data[selectedUser.data.length-1].sitStand}次`, s: evalResults.sitStandEval.text, h: `標準：>= ${evalResults.sitStandStd}次`, c: evalResults.sitStandEval.color },
                                                        { l: "柔軟度-柔軟度測驗", v: `${selectedUser.data[selectedUser.data.length-1].sitReach}cm`, s: evalResults.reachEval.text, h: `標準：常模等級`, c: evalResults.reachEval.color }
                                                    ].map((item, i) => (
                                                        <div key={i} className="flex justify-between items-center bg-white p-4 rounded-xl border-l-4 border-emerald-500 shadow-sm border border-slate-100 h-24">
                                                            <div className="flex flex-col justify-center"><p className="text-xs text-slate-400 font-bold">{item.l}</p><p className="text-xl font-black text-slate-700 leading-tight">{item.v}</p></div>
                                                            <div className="flex flex-col items-end justify-between h-full py-1"><p className={`text-xl font-black ${item.c}`}>{item.s}</p><p className="text-[10px] text-slate-400 font-bold">{item.h}</p></div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white p-8 rounded-3xl shadow-sm border border-slate-100 break-before-page">
                                        <h3 className="text-xl font-bold mb-8 text-slate-700 italic border-l-4 border-indigo-500 pl-4">Page 2: 歷年變化追蹤與臨床建議</h3>
                                        <div className="grid grid-cols-2 gap-6 mb-8">
                                            <div className="h-52 bg-slate-50 p-4 rounded-2xl border"><p className="text-xs font-bold text-slate-500 mb-2">1. 身體組成趨勢</p><ResponsiveContainer width="100%" height="100%"><LineChart data={selectedUser.data}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="date" hide /><YAxis /><Tooltip /><Line type="monotone" dataKey="bodyFat" stroke="#f43f5e" /><Line type="monotone" dataKey="sMM" stroke="#10b981" /></LineChart></ResponsiveContainer></div>
                                            <div className="h-52 bg-slate-50 p-4 rounded-2xl border"><p className="text-xs font-bold text-slate-500 mb-2">2. 心肺適能趨勢</p><ResponsiveContainer width="100%" height="100%"><LineChart data={selectedUser.data}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="date" hide /><YAxis /><Tooltip /><Line type="monotone" dataKey="walk6m" stroke="#6366f1" /></LineChart></ResponsiveContainer></div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-6">
                                            <div className="bg-indigo-50 p-6 rounded-2xl border border-indigo-100"><h4 className="font-bold text-indigo-700 mb-4">OT 職能運動建議</h4><ul className="text-sm text-slate-600 list-disc pl-4"><li>肌力強化：每週 3 次阻力訓練。</li><li>心肺訓練：增加每週 150 分鐘中強度運動。</li></ul></div>
                                            <div className="bg-emerald-50 p-6 rounded-2xl border border-emerald-100"><h4 className="font-bold text-emerald-700 mb-4">臨床營養建議</h4><ul className="text-sm text-slate-600 list-disc pl-4"><li>蛋白質攝取：維持每餐均勻攝取。</li><li>體重控制：控制總熱量並調整油脂攝取。</li></ul></div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {view === 'entry' && (
                        <div className="max-w-4xl mx-auto space-y-6">
                            <div className="bg-indigo-600 text-white p-6 rounded-2xl shadow-lg flex justify-between items-center">
                                <div><h3 className="text-xl font-bold flex items-center gap-2"><PlusCircle /> 新增評估數據</h3></div>
                                <div className="text-right"><label className="block text-[10px] uppercase font-bold opacity-70">評估日期</label><input type="date" value={newEntry.date} onChange={(e)=>setNewEntry({...newEntry, date: e.target.value})} className="bg-indigo-500 border-none rounded p-1 text-sm text-white" /></div>
                            </div>
                            <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                                <h4 className="font-bold text-slate-700 mb-6 flex items-center gap-2 border-b pb-2"><Info size={18}/> (1) 基本資料</h4>
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                    <div className="space-y-1"><label className="text-xs font-bold text-slate-500">床號</label><input type="text" value={newEntry.bed} onChange={(e)=>setNewEntry({...newEntry, bed: e.target.value})} className="w-full p-2 border rounded-lg bg-slate-50" /></div>
                                    <div className="space-y-1"><label className="text-xs font-bold text-slate-500">姓名</label><input type="text" value={newEntry.name} onChange={(e)=>setNewEntry({...newEntry, name: e.target.value})} className="w-full p-2 border rounded-lg bg-slate-50" /></div>
                                    <div className="space-y-1"><label className="text-xs font-bold text-slate-500">出生年月日</label><input type="date" value={newEntry.birthday} onChange={(e)=>setNewEntry({...newEntry, birthday: e.target.value})} className="w-full p-2 border rounded-lg bg-slate-50" /></div>
                                    <div className="space-y-1"><label className="text-xs font-bold text-slate-500">性別</label><select value={newEntry.gender} onChange={(e)=>setNewEntry({...newEntry, gender: e.target.value})} className="w-full p-2 border rounded-lg bg-slate-50"><option value="男">男</option><option value="女">女</option></select></div>
                                </div>
                            </div>
                            <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                                <h4 className="font-bold text-slate-700 mb-6 flex items-center gap-2 border-b pb-2"><Database size={18}/> (2) 身體素質</h4>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                                    {[ { l: "身高 (cm)", k: "height" }, { l: "體重 (kg)", k: "weight" }, { l: "體脂肪 (%)", k: "bodyFat" }, { l: "骨骼肌 (%)", k: "sMM" }, { l: "基礎代謝 (kcal)", k: "bmr" }, { l: "體年齡 (歲)", k: "bodyAge" }, { l: "內臟脂肪", k: "visceralFat" }, { l: "腰圍 (cm)", k: "waist" }, { l: "臀圍 (cm)", k: "hip" } ].map(f => (
                                        <div key={f.k} className="space-y-1"><label className="text-xs font-bold text-slate-500">{f.l}</label><input type="number" step="0.1" value={newEntry[f.k]} onChange={(e)=>setNewEntry({...newEntry, [f.k]: e.target.value})} className="w-full p-2 border rounded-lg bg-slate-50" /></div>
                                    ))}
                                </div>
                            </div>
                            <button onClick={handleAddEntry} className="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold shadow-lg hover:bg-indigo-700 transition transform active:scale-95">確認並儲存 (僅演示)</button>
                        </div>
                    )}

                    <style>{`
                        @media print {
                            body * { visibility: hidden; }
                            #report-content, #report-content * { visibility: visible; }
                            #report-content { position: absolute; left: 0; top: 0; width: 100%; }
                            .break-before-page { page-break-before: always; margin-top: 1cm; }
                        }
                    `}</style>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
