<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·èƒ½æ²»ç™‚é‹å‹•è©•ä¼°ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, RadarChart, PolarGrid, PolarAngleAxis, Radar } = window.Recharts;

        const calculateAge = (birthday) => {
            if (!birthday) return 0;
            const birthDate = new Date(birthday);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
            return age;
        };

        const getSitupsLevel = (count, gender) => {
            if (gender === 'ç”·') {
                if (count >= 45) return { text: "å¾ˆå¥½", color: "text-blue-600" };
                if (count >= 35) return { text: "è‰¯å¥½", color: "text-blue-600" };
                if (count >= 25) return { text: "é©ç•¶", color: "text-blue-600" };
                if (count >= 15) return { text: "ç¨å·®", color: "text-red-600" };
                return { text: "ä¸å¥½", color: "text-red-600" };
            } else {
                if (count >= 35) return { text: "å¾ˆå¥½", color: "text-blue-600" };
                if (count >= 25) return { text: "è‰¯å¥½", color: "text-blue-600" };
                if (count >= 15) return { text: "é©ç•¶", color: "text-blue-600" };
                if (count >= 10) return { text: "ç¨å·®", color: "text-red-600" };
                return { text: "ä¸å¥½", color: "text-red-600" };
            }
        };

        const getDetailedEvaluation = (data, gender, age) => {
            const d = data[data.length - 1];
            const h_m = d.height / 100;
            const bmi = (d.weight / (h_m * h_m)).toFixed(1);
            const bmiMax = (24 * h_m * h_m).toFixed(1);
            const bmiMin = (18.5 * h_m * h_m).toFixed(1);
            let bmiEval = bmi < 18.5 ? { text: "ä½æ–¼æ¨™æº–", color: "text-red-600" } : 
                         (bmi >= 24 ? { text: "é«˜æ–¼æ¨™æº–", color: "text-red-600" } : { text: "æ¨™æº–", color: "text-blue-600" });

            const fatLimit = gender === "ç”·" ? 20 : 30;
            const fatEval = d.bodyFat > fatLimit ? { text: "é«˜æ–¼æ¨™æº–", color: "text-red-600" } : { text: "æ¨™æº–", color: "text-blue-600" };

            const smmMin = gender === "ç”·" ? 32.9 : 25.9;
            const smmEval = d.sMM < smmMin ? { text: "ä½æ–¼æ¨™æº–", color: "text-red-600" } : { text: "æ¨™æº–", color: "text-blue-600" };

            const sMM_weight = (d.weight * d.sMM / 100).toFixed(1);
            const smi = (sMM_weight / (h_m * h_m)).toFixed(2);
            const smiLimit = gender === "ç”·" ? 7.0 : 5.7;
            const smiEval = parseFloat(smi) < smiLimit ? { text: "ä½æ–¼æ¨™æº–", color: "text-red-600" } : { text: "æ¨™æº–", color: "text-blue-600" };

            const vfEval = d.visceralFat >= 10 ? { text: "é«˜æ–¼æ¨™æº–", color: "text-red-600" } : { text: "æ¨™æº–", color: "text-blue-600" };
            const whr = (d.waist / d.hip).toFixed(2);
            const whrStd = gender === "ç”·" ? 0.92 : 0.88;
            const whrEval = parseFloat(whr) > whrStd ? { text: "é«˜æ–¼æ¨™æº–", color: "text-red-600" } : { text: "æ¨™æº–", color: "text-blue-600" };

            const sitStandStd = gender === "ç”·" ? (age >= 60 ? 18 : 24) : (age >= 60 ? 15 : 22);
            const sitStandEval = d.sitStand < sitStandStd ? { text: "ä½æ–¼æ¨™æº–", color: "text-red-600" } : { text: "æ¨™æº–", color: "text-blue-600" };

            const walkPredict = gender === "å¥³" ? (2.11 * d.height - 2.29 * d.weight - 5.78 * age + 667) : (7.57 * d.height - 1.76 * d.weight - 5.02 * age - 309);
            const walkMin = Math.round(gender === "å¥³" ? walkPredict - 139 : walkPredict - 153);
            const walkEval = d.walk6m < walkMin ? { text: "ä½æ–¼æ¨™æº–", color: "text-red-600" } : { text: "æ¨™æº–", color: "text-blue-600" };

            const situpsEval = getSitupsLevel(d.situps, gender);
            const reachStd = gender === "ç”·" ? 10 : 15;
            let reachEval = { text: "é©ç•¶", color: "text-blue-600" };
            if (d.sitReach >= (reachStd + 10)) reachEval = { text: "å¾ˆå¥½", color: "text-blue-600" };
            else if (d.sitReach >= (reachStd + 5)) reachEval = { text: "è‰¯å¥½", color: "text-blue-600" };
            else if (d.sitReach < (reachStd - 5)) reachEval = { text: "ä¸å¥½", color: "text-red-600" };
            else if (d.sitReach < reachStd) reachEval = { text: "ç¨å·®", color: "text-red-600" };

            const ageDiff = d.bodyAge - age;
            const ageDiffStr = ageDiff > 0 ? `+${ageDiff}` : `${ageDiff}`;
            const ageColor = ageDiff > 0 ? "text-red-600" : "text-blue-600";
            const ageEval = ageDiff > 0 ? { text: "é«˜æ–¼æ¨™æº–", color: "text-red-600" } : { text: "æ¨™æº–", color: "text-blue-600" };

            return { bmi, bmiMin, bmiMax, bmiEval, fatLimit, fatEval, smmMin, smmEval, smi, smiLimit, smiEval, vfEval, whr, whrStd, whrEval, sitStandStd, sitStandEval, walkMin, walkEval, situpsEval, reachStd, reachEval, sMM_weight, ageDiffStr, ageColor, ageEval };
        };

        const App = () => {
            const [view, setView] = useState('dashboard');
            const [selectedUserId, setSelectedUserId] = useState('');
            const [selectedDates, setSelectedDates] = useState([]);
            const [members, setMembers] = useState([]);

            useEffect(() => {
                fetch('https://script.google.com/macros/s/AKfycbwvgn6knfLN1xgBSCA7TWSR1pP5dAGyFWe6FDZ5y6Sfu0gXyM8Ewdo26LPsS-bO-Ptmdw/exec')
                    .then(r => r.json())
                    .then(rawData => {
                        // è½‰æ› Google Sheets æ ¼å¼ç‚ºéœ€è¦çš„çµæ§‹
                        const processedData = [];
                        const userMap = {};
                        
                        rawData.forEach(row => {
                            const userId = row.id;
                            if (!userMap[userId]) {
                                userMap[userId] = {
                                    id: userId,
                                    bed: row.bed,
                                    name: row.name,
                                    gender: row.gender,
                                    birthday: row.birthday,
                                    data: []
                                };
                            }
                            userMap[userId].data.push({
                                date: row.date,
                                weight: parseFloat(row.weight),
                                height: parseFloat(row.height),
                                bodyFat: parseFloat(row.bodyFat),
                                sMM: parseFloat(row.sMM),
                                visceralFat: parseFloat(row.visceralFat),
                                sitStand: parseFloat(row.sitStand),
                                walk6m: parseFloat(row.walk6m),
                                sitReach: parseFloat(row.sitReach),
                                situps: parseFloat(row.situps),
                                waist: parseFloat(row.waist),
                                hip: parseFloat(row.hip),
                                bmr: parseFloat(row.bmr),
                                bodyAge: parseFloat(row.bodyAge)
                            });
                        });
                        
                        setMembers(Object.values(userMap));
                    })
                    .catch(() => {
                        // å‚™ç”¨è³‡æ–™
                        setMembers([
                            { id: "001", bed: "A01", name: "ç‹å¤§æ˜", gender: "ç”·", birthday: "1985-05-20", data: [{ date: "2024-06-10", weight: 75, height: 175, bodyFat: 21, sMM: 33, visceralFat: 9, sitStand: 18, walk6m: 450, sitReach: 12, situps: 18, waist: 88, hip: 90, bmr: 1720, bodyAge: 38 }] },
                            { id: "002", bed: "B03", name: "æå°è¯", gender: "å¥³", birthday: "1990-11-10", data: [{ date: "2024-06-12", weight: 63, height: 160, bodyFat: 30, sMM: 25, visceralFat: 7, sitStand: 13, walk6m: 340, sitReach: 18, situps: 12, waist: 82, hip: 95, bmr: 1350, bodyAge: 35 }] }
                        ]);
                    });
            }, []);

            const allDates = useMemo(() => {
                const dates = new Set();
                members.forEach(m => m.data?.forEach(d => dates.add(d.date)));
                return Array.from(dates).sort();
            }, [members]);

            const sortedMembers = useMemo(() => members.sort((a, b) => a.id.localeCompare(b.id)), [members]);
            const selectedUser = members.find(m => m.id === selectedUserId);
            const evalResults = selectedUser ? getDetailedEvaluation(selectedUser.data, selectedUser.gender, calculateAge(selectedUser.birthday)) : null;

            const filteredStats = useMemo(() => {
                let total = 0, bmiAlert = 0, vfAlert = 0, smmAlert = 0, smiAlert = 0;
                let maleCount = 0, femaleCount = 0, ages = [];

                members.forEach(m => {
                    const age = calculateAge(m.birthday);
                    const hasData = m.data?.some(d => !selectedDates.length || selectedDates.includes(d.date));
                    if (hasData) {
                        ages.push(age);
                        if (m.gender === 'ç”·') maleCount++; else femaleCount++;
                        m.data?.forEach(d => {
                            if (!selectedDates.length || selectedDates.includes(d.date)) {
                                total++;
                                const res = getDetailedEvaluation([d], m.gender, age);
                                if (parseFloat(res.bmi) >= 27) bmiAlert++;
                                if (d.visceralFat >= 10) vfAlert++;
                                if (d.sMM < 30) smmAlert++;
                                if (parseFloat(res.smi) < parseFloat(res.smiLimit)) smiAlert++;
                            }
                        });
                    }
                });

                return {
                    total, bmiAlert, vfAlert, smmAlert, smiAlert,
                    maleCount, femaleCount, avgAge: ages.length ? (ages.reduce((a,b)=>a+b,0)/ages.length).toFixed(1) : 0,
                    memberTotal: Object.keys({}).length
                };
            }, [members, selectedDates]);

            const [newEntry, setNewEntry] = useState({
                date: new Date().toISOString().split('T')[0], bed: '', name: '', birthday: '', gender: 'ç”·',
                height: '', weight: '', bodyFat: '', sMM: '', bmr: '', bodyAge: '', visceralFat: '', waist: '', hip: '',
                situps: '', walk6m: '', sitStand: '', sitReach: ''
            });

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8">
                    <header className="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-indigo-900">è·èƒ½æ²»ç™‚é‹å‹•è©•ä¼°ç®¡ç†ç³»çµ±</h1>
                            <p className="text-slate-500 text-sm italic">OT Supervisor Management Console</p>
                        </div>
                        <nav className="flex bg-slate-100 p-1 rounded-xl space-x-1">
                            <button onClick={() => setView('dashboard')} className={`px-4 py-2 rounded-lg text-sm transition ${view === 'dashboard' ? 'bg-white shadow text-indigo-600 font-bold' : 'text-slate-500 hover:bg-slate-200'}`}>æ—ç¾¤åˆ†æ</button>
                            <button onClick={() => setView('individual')} className={`px-4 py-2 rounded-lg text-sm transition ${view === 'individual' ? 'bg-white shadow text-indigo-600 font-bold' : 'text-slate-500 hover:bg-slate-200'}`}>å€‹äººå ±å‘Š</button>
                            <button onClick={() => setView('entry')} className={`px-4 py-2 rounded-lg text-sm transition ${view === 'entry' ? 'bg-white shadow text-indigo-600 font-bold' : 'text-slate-500 hover:bg-slate-200'}`}>è³‡æ–™éŒ„å…¥</button>
                        </nav>
                    </header>

                    {view === 'dashboard' && (
                        <div className="space-y-6">
                            <div className="bg-white p-4 rounded-xl shadow-sm border flex flex-wrap items-center gap-4">
                                <span className="text-sm font-bold text-slate-500">è©•ä¼°æ—¥æœŸç¯©é¸:</span>
                                <div className="flex flex-wrap gap-2">
                                    {allDates.map(date => (
                                        <button key={date} onClick={() => setSelectedDates(prev => prev.includes(date) ? prev.filter(d => d !== date) : [...prev, date])} 
                                            className={`px-3 py-1 rounded-full text-xs transition ${selectedDates.includes(date) ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>
                                            {date}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="bg-white p-6 rounded-2xl shadow-sm border flex items-center gap-4">
                                    <div className="bg-indigo-100 p-3 rounded-xl text-indigo-600">ğŸ‘¥</div>
                                    <div><p className="text-xs font-bold text-slate-400">ç¸½è©•ä¼°äººæ•¸</p><h3 className="text-xl font-black text-slate-700">{filteredStats.memberTotal || 0} äºº</h3></div>
                                </div>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border flex items-center gap-4">
                                    <div className="bg-blue-100 p-3 rounded-xl text-blue-600">ğŸ‘¤</div>
                                    <div><p className="text-xs font-bold text-slate-400">ç”·å¥³æ¯”ä¾‹</p><h3 className="text-xl font-black text-slate-700">{filteredStats.maleCount} / {filteredStats.femaleCount}</h3></div>
                                </div>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border flex items-center gap-4">
                                    <div className="bg-emerald-100 p-3 rounded-xl text-emerald-600">ğŸ“…</div>
                                    <div><p className="text-xs font-bold text-slate-400">å¹³å‡å¹´é½¡</p><h3 className="text-xl font-black text-slate-700">{filteredStats.avgAge} æ­²</h3></div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div className="bg-white p-6 rounded-2xl border-l-4 border-indigo-500 shadow-sm text-center">
                                    <p className="text-slate-500 text-xs font-bold">è‚¥èƒ–è­¦ç¤º</p><h3 className="text-2xl font-black text-indigo-900">{filteredStats.bmiAlert} / {filteredStats.total}</h3>
                                </div>
                                <div className="bg-white p-6 rounded-2xl border-l-4 border-red-500 shadow-sm text-center">
                                    <p className="text-slate-500 text-xs font-bold">å…§è„‚è­¦ç¤º</p><h3 className="text-2xl font-black text-red-600">{filteredStats.vfAlert} / {filteredStats.total}</h3>
                                </div>
                                <div className="bg-white p-6 rounded-2xl border-l-4 border-amber-500 shadow-sm text-center">
                                    <p className="text-slate-500 text-xs font-bold">éª¨éª¼è‚Œä½</p><h3 className="text-2xl font-black text-amber-600">{filteredStats.smmAlert} / {filteredStats.total}</h3>
                                </div>
                                <div className="bg-white p-6 rounded-2xl border-l-4 border-rose-500 shadow-sm text-center">
                                    <p className="text-slate-500 text-xs font-bold">è‚Œå°‘é¢¨éšª</p><h3 className="text-2xl font-black text-rose-600">{filteredStats.smiAlert} / {filteredStats.total}</h3>
                                </div>
                            </div>
                        </div>
                    )}

                    {view === 'individual' && (
                        <div className="space-y-6">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border flex items-center gap-4">
                                <span className="text-slate-500 font-bold">å€‹æ¡ˆé¸æ“‡:</span>
                                <select value={selectedUserId} onChange={(e) => setSelectedUserId(e.target.value)} 
                                    className="flex-1 p-2 bg-slate-50 border rounded-xl focus:ring-2 ring-indigo-500">
                                    <option value="">è«‹é¸æ“‡å€‹æ¡ˆ</option>
                                    {sortedMembers.map(m => (
                                        <option key={m.id} value={m.id}>{m.id} - {m.name} ({m.bed})</option>
                                    ))}
                                </select>
                            </div>
                            {selectedUser && evalResults && (
                                <div className="bg-white p-8 rounded-3xl shadow-sm border">
                                    <div className="flex justify-between mb-6">
                                        <h2 className="text-3xl font-bold text-slate-800">
                                            {selectedUser.name} <span className="text-lg text-slate-400">
                                            {calculateAge(selectedUser.birthday)}æ­² | {selectedUser.gender} | {selectedUser.data[selectedUser.data.length-1]?.date}
                                        </span></h2>
                                        <button onClick={() => window.print()} className="bg-indigo-600 text-white px-4 py-2 rounded-xl flex items-center gap-2">
                                            ğŸ“„ åˆ—å°å ±å‘Š
                                        </button>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div>
                                            <h4 className="font-bold text-indigo-600 mb-4">èº«é«”çµ„æˆæŒ‡æ¨™</h4>
                                            <div className="grid grid-cols-2 gap-4 text-sm">
                                                <div><strong>BMI:</strong> {evalResults.bmi} <span className={evalResults.bmiEval.color}>{evalResults.bmiEval.text}</span></div>
                                                <div><strong>é«”è„‚:</strong> {selectedUser.data[selectedUser.data.length-1].bodyFat}% <span className={evalResults.fatEval.color}>{evalResults.fatEval.text}</span></div>
                                                <div><strong>éª¨éª¼è‚Œ:</strong> {selectedUser.data[selectedUser.data.length-1].sMM}% <span className={evalResults.smmEval.color}>{evalResults.smmEval.text}</span></div>
                                                <div><strong>å…§è‡Ÿè„‚è‚ª:</strong> {selectedUser.data[selectedUser.data.length-1].visceralFat} <span className={evalResults.vfEval.color}>{evalResults.vfEval.text}</span></div>
                                            </div>
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-emerald-600 mb-4">é«”èƒ½è¡¨ç¾</h4>
                                            <div className="grid grid-cols-2 gap-4 text-sm">
                                                <div><strong>ä»°è‡¥èµ·å:</strong> {selectedUser.data[selectedUser.data.length-1].situps}æ¬¡ <span className={evalResults.situpsEval.color}>{evalResults.situpsEval.text}</span></div>
                                                <div><strong>6åˆ†é˜è¡Œèµ°:</strong> {selectedUser.data[selectedUser.data.length-1].walk6m}m <span className={evalResults.walkEval.color}>{evalResults.walkEval.text}</span></div>
                                                <div><strong>30ç§’åç«™:</strong> {selectedUser.data[selectedUser.data.length-1].sitStand}æ¬¡ <span className={evalResults.sitStandEval.color}>{evalResults.sitStandEval.text}</span></div>
                                                <div><strong>æŸ”è»Ÿåº¦:</strong> {selectedUser.data[selectedUser.data.length-1].sitReach}cm <span className={evalResults.reachEval.color}>{evalResults.reachEval.text}</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {view === 'entry' && (
                        <div className="max-w-4xl mx-auto space-y-6">
                            <div className="bg-indigo-600 text-white p-6 rounded-2xl shadow-lg">
                                <h3 className="text-xl font-bold">æ–°å¢è©•ä¼°æ•¸æ“š</h3>
                            </div>
                            <div className="bg-white p-8 rounded-2xl shadow-sm border">
                                <h4 className="font-bold text-slate-700 mb-6">åŸºæœ¬è³‡æ–™</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label className="text-xs font-bold text-slate-500 block mb-1">åºŠè™Ÿ</label><input type="text" value={newEntry.bed} onChange={(e)=>setNewEntry({...newEntry, bed: e.target.value})} className="w-full p-2 border rounded-lg bg-slate-50" /></div>
                                    <div><label className="text-xs font-bold text-slate-500 block mb-1">å§“å</label><input type="text" value={newEntry.name} onChange={(e)=>setNewEntry({...newEntry, name: e.target.value})} className="w-full p-2 border rounded-lg bg-slate-50" /></div>
                                    <div><label className="text-xs font-bold text-slate-500 block mb-1">å‡ºç”Ÿæ—¥æœŸ</label><input type="date" value={newEntry.birthday} onChange={(e)=>setNewEntry({...newEntry, birthday: e.target.value})} className="w-full p-2 border rounded-lg bg-slate-50" /></div>
                                    <div><label className="text-xs font-bold text-slate-500 block mb-1">æ€§åˆ¥</label><select value={newEntry.gender} onChange={(e)=>setNewEntry({...newEntry, gender: e.target.value})} className="w-full p-2 border rounded-lg bg-slate-50"><option>ç”·</option><option>å¥³</option></select></div>
                                </div>
                            </div>
                            <div className="bg-white p-8 rounded-2xl shadow-sm border">
                                <h4 className="font-bold text-slate-700 mb-6">èº«é«”æ•¸æ“š</h4>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <div><label className="text-xs block mb-1">èº«é«˜(cm)</label><input type="number" value={newEntry.height} onChange={(e)=>setNewEntry({...newEntry, height: e.target.value})} className="w-full p-2 border rounded bg-slate-50" /></div>
                                    <div><label className="text-xs block mb-1">é«”é‡(kg)</label><input type="number" value={newEntry.weight} onChange={(e)=>setNewEntry({...newEntry, weight: e.target.value})} className="w-full p-2 border rounded bg-slate-50" /></div>
                                    <div><label className="text-xs block mb-1">é«”è„‚(%)</label><input type="number" value={newEntry.bodyFat} onChange={(e)=>setNewEntry({...newEntry, bodyFat: e.target.value})} className="w-full p-2 border rounded bg-slate-50" /></div>
                                </div>
                            </div>
                            <button className="w-full bg-indigo-600 text-white p-4 rounded-2xl font-bold hover:bg-indigo-700">å„²å­˜åˆ° Google Sheetsï¼ˆè«‹æ‰‹å‹•æ–°å¢ï¼‰</button>
                            <p className="text-xs text-slate-500 text-center">ğŸ’¡ ç›®å‰ç‚ºè®€å–æ¨¡å¼ï¼Œè«‹å°‡è³‡æ–™è¤‡è£½åˆ° Google Sheets å¾Œé‡æ–°æ•´ç†</p>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
